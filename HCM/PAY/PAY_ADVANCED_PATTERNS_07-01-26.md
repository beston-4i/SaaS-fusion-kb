# PAYROLL Module - Advanced Patterns Update

**Date:** 07-Jan-2026  
**Purpose:** New patterns discovered from "Reupdate for knowledge" queries  
**Source:** 10 payroll production queries analyzed  
**Status:** Production-Ready

---

## ðŸš¨ NEW CRITICAL PATTERNS DISCOVERED

### 1. Dynamic Payroll Report (Element-Agnostic)

**Problem:** Create flexible payroll reports that work with any element configuration

**Solution:**

```sql
WITH PER_RES AS (
    SELECT
        PPRD.PERSON_ID,
        PTP.PERIOD_NAME,
        TO_CHAR(PTP.START_DATE, 'YYYY') YEAR,
        DECODE(PTP.PERIOD_NUM,
            '1', 'January', '2', 'February', '3', 'March', '4', 'April',
            '5', 'May', '6', 'June', '7', 'July', '8', 'August',
            '9', 'September', '10', 'October', '11', 'November', '12', 'December'
        ) MONTH,
        PPA.DATE_EARNED,
        PPA.EFFECTIVE_DATE,
        PAP.PAYROLL_NAME,
        PPA.PAYROLL_ID,
        PCS.CONSOLIDATION_SET_NAME,
        PCS.CONSOLIDATION_SET_ID,
        PETT.ELEMENT_NAME,
        
        -- Aggregate by classification
        SUM(CASE 
            WHEN PEC.BASE_CLASSIFICATION_NAME = 'Standard Earnings'
            THEN TO_NUMBER(PRRV.RESULT_VALUE)
            ELSE 0
        END) TOTAL_EARNINGS,
        
        SUM(CASE 
            WHEN PEC.BASE_CLASSIFICATION_NAME IN ('Voluntary Deductions', 
                                                  'Social Insurance Deductions', 
                                                  'Involuntary Deductions')
            THEN TO_NUMBER(PRRV.RESULT_VALUE)
            ELSE 0
        END) DEDUCTIONS,
        
        -- Custom order for display
        CASE
            WHEN PEC.BASE_CLASSIFICATION_NAME = 'Standard Earnings' THEN 1
            WHEN PEC.BASE_CLASSIFICATION_NAME IN ('Voluntary Deductions', 
                                                  'Social Insurance Deductions', 
                                                  'Involuntary Deductions') THEN 2
            ELSE 3
        END AS CUSTOM_ORDER
        
    FROM
        PAY_RUN_RESULT_VALUES PRRV,
        PAY_RUN_RESULTS PRR,
        PAY_PAYROLL_REL_ACTIONS PPRA,
        PAY_PAYROLL_ACTIONS PPA,
        PAY_PAY_RELATIONSHIPS_DN PPRD,
        PAY_TIME_PERIODS PTP,
        PAY_ELEMENT_TYPES_F PETF,
        PAY_ELEMENT_TYPES_TL PETT,
        PAY_INPUT_VALUES_F PIVF,
        PAY_ALL_PAYROLLS_F PAP,
        PAY_ELE_CLASSIFICATIONS PEC,
        PAY_CONSOLIDATION_SETS PCS,
        PAY_REQUESTS PRQ,
        PAY_FLOW_INSTANCES PFI
    WHERE
        PRRV.RUN_RESULT_ID = PRR.RUN_RESULT_ID
        AND PRR.PAYROLL_REL_ACTION_ID = PPRA.PAYROLL_REL_ACTION_ID
        AND PPRA.PAYROLL_ACTION_ID = PPA.PAYROLL_ACTION_ID
        AND PPRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
        
        -- Payroll run filters
        AND PPA.ACTION_TYPE IN ('Q', 'R')
        AND PPA.ACTION_STATUS = 'C'
        AND PPRA.RETRO_COMPONENT_ID IS NULL
        
        -- Element linkage
        AND PETF.ELEMENT_TYPE_ID = PRR.ELEMENT_TYPE_ID
        AND PETF.ELEMENT_TYPE_ID = PETT.ELEMENT_TYPE_ID
        AND PIVF.ELEMENT_TYPE_ID = PETF.ELEMENT_TYPE_ID
        AND PIVF.INPUT_VALUE_ID = PRRV.INPUT_VALUE_ID
        
        -- Classification filter
        AND PETF.CLASSIFICATION_ID = PEC.CLASSIFICATION_ID
        AND PEC.BASE_CLASSIFICATION_NAME IN ('Standard Earnings', 
                                             'Voluntary Deductions', 
                                             'Social Insurance Deductions', 
                                             'Involuntary Deductions')
        
        -- Pay value only
        AND UPPER(TRIM(PIVF.BASE_NAME)) = 'PAY VALUE'
        
        -- Language
        AND PETT.LANGUAGE = 'US'
        
        -- Period linkage
        AND PPA.EARN_TIME_PERIOD_ID = PTP.TIME_PERIOD_ID
        AND PPA.PAYROLL_ID = PAP.PAYROLL_ID
        
        -- Flow instance tracking
        AND PPA.PAY_REQUEST_ID = PRQ.PAY_REQUEST_ID
        AND PRQ.FLOW_INSTANCE_ID = PFI.FLOW_INSTANCE_ID
        AND PPA.CONSOLIDATION_SET_ID = PCS.CONSOLIDATION_SET_ID
        
        -- Date filters
        AND TRUNC(PPA.DATE_EARNED) BETWEEN PETF.EFFECTIVE_START_DATE AND PETF.EFFECTIVE_END_DATE
        AND TRUNC(PPA.DATE_EARNED) BETWEEN PIVF.EFFECTIVE_START_DATE AND PIVF.EFFECTIVE_END_DATE
        AND TRUNC(PPA.DATE_EARNED) BETWEEN PAP.EFFECTIVE_START_DATE AND PAP.EFFECTIVE_END_DATE
        
        -- Parameters
        AND TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) = NVL(TO_DATE(:P_PERIOD_NAME, 'DD-MM-YYYY'), TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)))
        AND PAP.PAYROLL_NAME = NVL(:P_PAYROLLNAME, PAP.PAYROLL_NAME)
        AND PFI.INSTANCE_NAME = NVL(:P_FLOW_NAME, PFI.INSTANCE_NAME)
        
    GROUP BY
        PPRD.PERSON_ID,
        PTP.PERIOD_NAME,
        PPA.DATE_EARNED,
        PPA.EFFECTIVE_DATE,
        PTP.START_DATE,
        PTP.PERIOD_NUM,
        PAP.PAYROLL_NAME,
        TO_CHAR(PTP.START_DATE, 'YYYY'),
        PCS.CONSOLIDATION_SET_NAME,
        PCS.CONSOLIDATION_SET_ID,
        PETT.ELEMENT_NAME,
        PPA.PAYROLL_ID,
        PEC.BASE_CLASSIFICATION_NAME
)
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.DISPLAY_NAME EMPLOYEE_NAME,
    
    -- Assignment details
    PAAF.ASSIGNMENT_NUMBER,
    ORG.NAME DEPARTMENT,
    JOB.NAME JOB,
    GRADE.NAME GRADE,
    
    -- Period
    PR.PERIOD_NAME,
    PR.YEAR,
    PR.MONTH,
    
    -- Payroll
    PR.PAYROLL_NAME,
    PR.CONSOLIDATION_SET_NAME,
    
    -- Element name
    PR.ELEMENT_NAME,
    
    -- Values
    NVL(PR.TOTAL_EARNINGS, 0) EARNINGS,
    NVL(PR.DEDUCTIONS, 0) DEDUCTIONS,
    
    -- Net pay (sum over person for all elements)
    SUM(NVL(PR.TOTAL_EARNINGS, 0) - NVL(PR.DEDUCTIONS, 0)) OVER (PARTITION BY PAPF.PERSON_ID) NET_PAY
    
FROM
    PER_RES PR,
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    PER_ALL_ASSIGNMENTS_F PAAF,
    PER_DEPARTMENTS ORG,
    PER_JOBS_F_VL JOB,
    PER_GRADES_F_VL GRADE
WHERE
    PR.PERSON_ID = PAPF.PERSON_ID
    AND PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = PAAF.PERSON_ID
    
    AND PAAF.ORGANIZATION_ID = ORG.ORGANIZATION_ID(+)
    AND PAAF.JOB_ID = JOB.JOB_ID(+)
    AND PAAF.GRADE_ID = GRADE.GRADE_ID(+)
    
    AND PPNF.NAME_TYPE = 'GLOBAL'
    AND PAAF.ASSIGNMENT_TYPE = 'E'
    AND PAAF.PRIMARY_FLAG = 'Y'
    AND PAAF.EFFECTIVE_LATEST_CHANGE = 'Y'
    
    -- Use termination date if terminated
    AND NVL(PPOS.ACTUAL_TERMINATION_DATE, TRUNC(LAST_DAY(PR.EFFECTIVE_DATE)))
        BETWEEN PAAF.EFFECTIVE_START_DATE AND PAAF.EFFECTIVE_END_DATE
    
    AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PPNF.EFFECTIVE_START_DATE AND PPNF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN ORG.EFFECTIVE_START_DATE(+) AND ORG.EFFECTIVE_END_DATE(+)
    AND TRUNC(SYSDATE) BETWEEN JOB.EFFECTIVE_START_DATE(+) AND JOB.EFFECTIVE_END_DATE(+)
    AND TRUNC(SYSDATE) BETWEEN GRADE.EFFECTIVE_START_DATE(+) AND GRADE.EFFECTIVE_END_DATE(+)
    
ORDER BY
    CAST(PAPF.PERSON_NUMBER AS NUMBER DEFAULT 9999999999 ON CONVERSION ERROR),
    PR.CUSTOM_ORDER
```

**Benefits:**
- âœ… Works with any element configuration
- âœ… No hardcoded element names
- âœ… Dynamically aggregates by classification
- âœ… Handles multiple payrolls
- âœ… Tracks flow instance for audit

**Key Tables:**
- `PAY_CONSOLIDATION_SETS` - Consolidation set tracking
- `PAY_REQUESTS` - Payroll request
- `PAY_FLOW_INSTANCES` - Specific payroll run instance

---

### 2. Specific Element Extraction Pattern

**Problem:** Extract specific earning and deduction elements by name

**Solution:**

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.FULL_NAME,
    PAAF.ASSIGNMENT_NUMBER,
    
    -- Basic salary element entry
    (SELECT ROUND(PEEV.SCREEN_ENTRY_VALUE / 12, 2)
     FROM
         PAY_ELEMENT_TYPES_VL PETV1,
         PAY_ELEMENT_ENTRIES_F PEEF1,
         PAY_ELEMENT_ENTRY_VALUES_F PEEV,
         PAY_INPUT_VALUES_VL PIVL
     WHERE
         PETV1.ELEMENT_TYPE_ID = PEEF1.ELEMENT_TYPE_ID
         AND PAPF.PERSON_ID = PEEF1.PERSON_ID
         AND PEEF1.ELEMENT_ENTRY_ID = PEEV.ELEMENT_ENTRY_ID
         AND PEEV.INPUT_VALUE_ID = PIVL.INPUT_VALUE_ID
         
         -- Element identification
         AND PETV1.BASE_ELEMENT_NAME = 'Basic'
         AND UPPER(TRIM(PIVL.NAME)) = UPPER(TRIM('AMOUNT'))
         
         AND PEEV.SCREEN_ENTRY_VALUE IS NOT NULL
         
         -- Date filter (handle termination)
         AND LEAST(NVL(PPOS.ACTUAL_TERMINATION_DATE, TRUNC(:P_DATE)), TRUNC(:P_DATE))
             BETWEEN TRUNC(PEEF1.EFFECTIVE_START_DATE) AND TRUNC(PEEF1.EFFECTIVE_END_DATE)
         AND LEAST(NVL(PPOS.ACTUAL_TERMINATION_DATE, TRUNC(:P_DATE)), TRUNC(:P_DATE))
             BETWEEN TRUNC(PEEV.EFFECTIVE_START_DATE) AND TRUNC(PEEV.EFFECTIVE_END_DATE)
         AND LEAST(NVL(PPOS.ACTUAL_TERMINATION_DATE, TRUNC(:P_DATE)), TRUNC(:P_DATE))
             BETWEEN TRUNC(PIVL.EFFECTIVE_START_DATE) AND TRUNC(PIVL.EFFECTIVE_END_DATE)
         
         AND ROWNUM = 1
    ) BASIC_SALARY,
    
    -- Payroll run elements (from specific period)
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Basic', TO_NUMBER(PRRV.RESULT_VALUE), 0)) BASIC_PAY,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Housing Allowance', TO_NUMBER(PRRV.RESULT_VALUE), 0)) HRA,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Transport Allowance', TO_NUMBER(PRRV.RESULT_VALUE), 0)) TRANSPORT_ALLOWANCE,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Food Allowance', TO_NUMBER(PRRV.RESULT_VALUE), 0)) FOOD_ALLOWANCE,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Mobile Allowance', TO_NUMBER(PRRV.RESULT_VALUE), 0)) MOBILE_ALLOWANCE,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Other Allowance', TO_NUMBER(PRRV.RESULT_VALUE), 0)) OTHER_ALLOWANCE,
    
    -- Overtime
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Holidays Overtime', TO_NUMBER(PRRV.RESULT_VALUE), 0)) HOLIDAY_OVERTIME,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Normal Overtime', TO_NUMBER(PRRV.RESULT_VALUE), 0)) NORMAL_OVERTIME,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Weekend Overtime', TO_NUMBER(PRRV.RESULT_VALUE), 0)) WEEKEND_OVERTIME,
    
    -- One-time payments
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Air Ticket Encasement', TO_NUMBER(PRRV.RESULT_VALUE), 0)) AIR_TICKET,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Annual Bonus', TO_NUMBER(PRRV.RESULT_VALUE), 0)) ANNUAL_BONUS,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Arrears', TO_NUMBER(PRRV.RESULT_VALUE), 0)) ARREARS,
    
    -- Claims
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Domestic Food Claims', TO_NUMBER(PRRV.RESULT_VALUE), 0)) DOMESTIC_FOOD,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Domestic Hotel Claims', TO_NUMBER(PRRV.RESULT_VALUE), 0)) DOMESTIC_HOTEL,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Domestic Travel Claims', TO_NUMBER(PRRV.RESULT_VALUE), 0)) DOMESTIC_TRAVEL,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Expense Or Deposit Refunds', TO_NUMBER(PRRV.RESULT_VALUE), 0)) EXPENSE_REFUNDS,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Visa Deposit Claims', TO_NUMBER(PRRV.RESULT_VALUE), 0)) VISA_DEPOSIT,
    
    -- Total earnings by classification
    SUM(DECODE(PEC.CLASSIFICATION_NAME, 'Standard Earnings', TO_NUMBER(PRRV.RESULT_VALUE), 0)) TOTAL_EARNINGS,
    
    -- Deductions
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Housing Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) HOUSING_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Mobile Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) MOBILE_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Fines and Penalties Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) FINES_PENALTIES,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Food Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) FOOD_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Insurance Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) INSURANCE_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Other Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) OTHER_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Pension Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) PENSION_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Salary Advance Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) SALARY_ADVANCE_DED,
    SUM(DECODE(PET_TL.ELEMENT_NAME, 'Transport Deduction Results', TO_NUMBER(PRRV.RESULT_VALUE), 0)) TRANSPORT_DED,
    
    -- Total deductions
    SUM(DECODE(PEC.CLASSIFICATION_NAME, 'Voluntary Deductions', TO_NUMBER(PRRV.RESULT_VALUE), 0)) TOTAL_DEDUCTIONS,
    
    -- Net salary
    (SUM(DECODE(PEC.CLASSIFICATION_NAME, 'Standard Earnings', TO_NUMBER(PRRV.RESULT_VALUE), 0)) -
     SUM(DECODE(PEC.CLASSIFICATION_NAME, 'Voluntary Deductions', TO_NUMBER(PRRV.RESULT_VALUE), 0))) NET_SALARY
    
FROM
    PER_ALL_ASSIGNMENTS_F PAAF,
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    PER_PERIODS_OF_SERVICE PPOS,
    PAY_PAY_RELATIONSHIPS_DN PPRD,
    PAY_PAYROLL_REL_ACTIONS PPRA,
    PAY_PAYROLL_ACTIONS PPA,
    PAY_RUN_RESULTS PRR,
    PAY_RUN_RESULT_VALUES PRRV,
    PAY_ELEMENT_TYPES_TL PET_TL,
    PAY_ELEMENT_TYPES_F PET,
    PAY_INPUT_VALUES_F PIV,
    PAY_ELE_CLASSIFICATIONS_TL PEC
WHERE
    PAAF.PERSON_ID = PAPF.PERSON_ID
    AND PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = PPOS.PERSON_ID
    AND PAPF.PERSON_ID = PPRD.PERSON_ID
    
    AND PPRD.PAYROLL_RELATIONSHIP_ID = PPRA.PAYROLL_RELATIONSHIP_ID
    AND PPRA.PAYROLL_ACTION_ID = PPA.PAYROLL_ACTION_ID
    AND PPRA.PAYROLL_REL_ACTION_ID = PRR.PAYROLL_REL_ACTION_ID
    AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
    
    AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
    AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
    AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
    
    AND PET.CLASSIFICATION_ID = PEC.CLASSIFICATION_ID
    
    AND PPNF.NAME_TYPE = 'GLOBAL'
    AND PET_TL.LANGUAGE = USERENV('LANG')
    AND PEC.LANGUAGE = 'US'
    
    -- Pay value only
    AND UPPER(PIV.NAME) = UPPER('Pay Value')
    
    -- Payroll filters
    AND PPA.ACTION_TYPE IN ('Q', 'R')
    AND PPA.DATE_EARNED = :P_DATE
    AND PPRA.RETRO_COMPONENT_ID IS NULL
    
    AND PAAF.ASSIGNMENT_TYPE = 'E'
    AND PAAF.PRIMARY_FLAG = 'Y'
    
    AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PPNF.EFFECTIVE_START_DATE AND PPNF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PAAF.EFFECTIVE_START_DATE AND PAAF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
    
GROUP BY
    PAPF.PERSON_NUMBER,
    PPNF.FULL_NAME,
    PAAF.ASSIGNMENT_NUMBER,
    PPOS.WORKER_NUMBER,
    ORG.NAME,
    JOB.NAME,
    GRADE.NAME,
    PPA.ACTION_TYPE
```

**Key Difference:**
- **Dynamic**: Uses GROUP BY and classification aggregation
- **Specific**: Uses DECODE for specific element names

**Use Dynamic When:**
- Element names vary by implementation
- Need element-agnostic reporting
- Building generic reports

**Use Specific When:**
- Element names are standardized
- Need fixed column layout
- Better performance (no aggregation needed)

---

### 3. Balance Extraction Pattern

**Problem:** Get balance values (gratuity provision, airfare provision, etc.)

**Solution:**

```sql
SELECT
    PPRD.PERSON_ID,
    PPA.EFFECTIVE_DATE,
    PPA.DATE_EARNED,
    PPA.PAYROLL_ACTION_ID,
    
    -- Balance value
    BAL.BALANCE_VALUE,
    
    -- Balance name (mapped)
    CASE
        WHEN PBT.BALANCE_NAME = 'DYR_Gratuity_Provision' THEN 'Gratuity Provision'
        WHEN PBT.BALANCE_NAME = 'Air Fare Provision' THEN 'Airfare Provision'
        ELSE PBT.BALANCE_NAME
    END BALANCE_NAME
    
FROM
    PER_LEGISLATIVE_DATA_GROUPS_VL LDG,
    PAY_PAY_RELATIONSHIPS_DN PPRD,
    PAY_PAYROLL_REL_ACTIONS PRA,
    PAY_PAYROLL_ACTIONS PPA,
    PAY_ACTION_CLASSES PAC,
    PAY_BALANCE_TYPES_VL PBT,
    TABLE(PAY_BALANCE_VIEW_PKG.GET_BALANCE_DIMENSIONS(
        P_BALANCE_TYPE_ID => PBT.BALANCE_TYPE_ID,
        P_PAYROLL_REL_ACTION_ID => PRA.PAYROLL_REL_ACTION_ID,
        P_PAYROLL_TERM_ID => NULL,
        P_PAYROLL_ASSIGNMENT_ID => NULL
    )) BAL,
    PAY_DIMENSION_USAGES_VL PDU,
    PAY_ALL_PAYROLLS_F PAP,
    PER_ALL_PEOPLE_F PAPF1
WHERE
    PPRD.LEGISLATIVE_DATA_GROUP_ID = LDG.LEGISLATIVE_DATA_GROUP_ID
    AND PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
    AND PRA.RETRO_COMPONENT_ID IS NULL
    
    -- Ensure results exist
    AND EXISTS (
        SELECT 1
        FROM PAY_RUN_RESULTS PRR
        WHERE PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
    )
    
    AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
    AND PAC.ACTION_TYPE = PPA.ACTION_TYPE
    AND PAC.CLASSIFICATION_NAME = 'SEQUENCED'
    AND PPA.PAYROLL_ID = PAP.PAYROLL_ID
    AND PPA.ACTION_TYPE IN ('Q', 'R')
    AND PPA.ACTION_STATUS = 'C'
    
    -- Balance type
    AND NVL(PBT.LEGISLATION_CODE, LDG.LEGISLATION_CODE) = LDG.LEGISLATION_CODE
    AND NVL(PBT.LEGISLATIVE_DATA_GROUP_ID, LDG.LEGISLATIVE_DATA_GROUP_ID) = LDG.LEGISLATIVE_DATA_GROUP_ID
    AND PBT.BALANCE_NAME IN ('Air Fare Provision', 'DYR_Gratuity_Provision')
    
    -- Dimension
    AND PDU.DIMENSION_NAME = 'Assignment Inception to Date'
    AND PDU.BALANCE_DIMENSION_ID = BAL.BALANCE_DIMENSION_ID
    AND NVL(PDU.LEGISLATION_CODE, LDG.LEGISLATION_CODE) = LDG.LEGISLATION_CODE
    AND NVL(PDU.LEGISLATIVE_DATA_GROUP_ID, LDG.LEGISLATIVE_DATA_GROUP_ID) = LDG.LEGISLATIVE_DATA_GROUP_ID
    
    AND PPRD.PERSON_ID = PAPF1.PERSON_ID
    AND BAL.BALANCE_VALUE <> '0'
    
    -- Period filter
    AND PAP.PAYROLL_ID = NVL(:P_PAYROLL, PAP.PAYROLL_ID)
    AND TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) = NVL(TO_DATE(:P_PERIOD, 'DDMMYYYY'), TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)))
```

**Key Function:**
- `PAY_BALANCE_VIEW_PKG.GET_BALANCE_DIMENSIONS` - Extracts balance values

**Common Balances:**
- `'Air Fare Provision'` - Airfare accrual
- `'DYR_Gratuity_Provision'` / `'Gratuity Provision'` - Gratuity accrual
- `'Annual Leave Accrual'` - Leave liability

**Dimensions:**
- `'Assignment Inception to Date'` - Total since hire
- `'Assignment Run to Date'` - Total in current assignment
- `'Assignment Period to Date'` - Current period only

---

### 4. Information Elements Pattern

**Problem:** Extract information elements (non-monetary values)

**Solution:**

```sql
SELECT
    PPRD.PERSON_ID,
    PTP.PERIOD_NAME,
    PPA.EFFECTIVE_DATE,
    PETF.BASE_ELEMENT_NAME ELEMENT_NAME,
    PRRV.RESULT_VALUE
FROM
    PAY_RUN_RESULT_VALUES PRRV,
    PAY_RUN_RESULTS PRR,
    PAY_PAYROLL_REL_ACTIONS PPRA,
    PAY_PAYROLL_ACTIONS PPA,
    PAY_PAY_RELATIONSHIPS_DN PPRD,
    PAY_TIME_PERIODS PTP,
    PAY_ELEMENT_TYPES_F PETF,
    PAY_INPUT_VALUES_F PIVF,
    PAY_ALL_PAYROLLS_F PAP,
    PAY_ELE_CLASSIFICATIONS PEC
WHERE
    PRRV.RUN_RESULT_ID = PRR.RUN_RESULT_ID
    AND PRR.PAYROLL_REL_ACTION_ID = PPRA.PAYROLL_REL_ACTION_ID
    AND PPRA.PAYROLL_ACTION_ID = PPA.PAYROLL_ACTION_ID
    AND PPRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
    
    AND PPA.ACTION_TYPE IN ('Q', 'R')
    AND PPA.ACTION_STATUS = 'C'
    AND PPA.EARN_TIME_PERIOD_ID = PTP.TIME_PERIOD_ID
    
    AND PETF.ELEMENT_TYPE_ID = PRR.ELEMENT_TYPE_ID
    AND PIVF.ELEMENT_TYPE_ID = PETF.ELEMENT_TYPE_ID
    AND PIVF.INPUT_VALUE_ID = PRRV.INPUT_VALUE_ID
    AND PPA.PAYROLL_ID = PAP.PAYROLL_ID
    
    AND PETF.CLASSIFICATION_ID = PEC.CLASSIFICATION_ID
    
    -- INFORMATION classification only
    AND PEC.BASE_CLASSIFICATION_NAME = 'Information'
    
    AND PIVF.BASE_NAME = 'Pay Value'
    AND PETF.BASE_ELEMENT_NAME NOT LIKE '%Results'
    
    AND PPRA.RETRO_COMPONENT_ID IS NULL
    
    AND TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) = NVL(TO_DATE(:P_PERIOD, 'DD-MM-YYYY'), TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)))
    AND TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) BETWEEN PETF.EFFECTIVE_START_DATE AND PETF.EFFECTIVE_END_DATE
    AND TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) BETWEEN PIVF.EFFECTIVE_START_DATE AND PIVF.EFFECTIVE_END_DATE
    
    AND PAP.PAYROLL_ID = NVL(:P_PAYROLL, PAP.PAYROLL_ID)
```

**Information Elements (Common):**
- Days worked
- Hours worked
- Working days
- FTE calculations
- Headcount values

---

### 5. Payroll Bank Details

**Problem:** Get bank payment details for payslip

**Solution:**

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.DISPLAY_NAME,
    
    -- Payment method
    NVL(PPT.BASE_PAYMENT_TYPE_NAME, 
        NVL(PPPMF.NAME, 
            NVL(POPM.ORG_PAYMENT_METHOD_NAME, PPT.PAYMENT_TYPE_NAME))) PAY_METHOD_NAME,
    
    -- Bank details
    PBA.BANK_NAME,
    PBA.BANK_ACCOUNT_NAME,
    PBA.BANK_ACCOUNT_NUM BANK_ACCOUNT_NUMBER,
    PBA.IBAN_NUMBER IBAN,
    PBA.CURRENCY_CODE,
    PBA.BANK_BRANCH_NAME BRANCH_NAME,
    
    -- Payment details from payslip
    PCPV.PERIOD_START_DATE,
    PCPV.PERIOD_END_DATE,
    PCPV.PAYMENT_DATE,
    PCPV.TAX_REFERENCE,
    PCPV.AMOUNT NET_PAY_AMOUNT
    
FROM
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    PAY_PAYROLL_ASSIGNMENTS PPA,
    PAY_PERSONAL_PAYMENT_METHODS_F PPPMF,
    PAY_BANK_ACCOUNTS PBA,
    PAY_ORG_PAY_METHODS_VL POPM,
    PAY_PAYMENT_TYPES_VL PPT,
    PAY_CARD_PAYSLIPS_V PCPV
WHERE
    PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = PPA.PERSON_ID
    
    AND PPA.PAYROLL_RELATIONSHIP_ID = PPPMF.PAYROLL_RELATIONSHIP_ID(+)
    AND PPPMF.BANK_ACCOUNT_ID = PBA.BANK_ACCOUNT_ID(+)
    AND PPPMF.ORG_PAYMENT_METHOD_ID = POPM.ORG_PAYMENT_METHOD_ID(+)
    AND POPM.PAYMENT_TYPE_ID = PPT.PAYMENT_TYPE_ID(+)
    
    AND PPA.PERSON_ID = PCPV.PERSON_ID(+)
    
    AND PPNF.NAME_TYPE = 'GLOBAL'
    
    -- Period filter
    AND TO_DATE(:P_PERIOD, 'DDMMYYYY') BETWEEN PPPMF.EFFECTIVE_START_DATE AND PPPMF.EFFECTIVE_END_DATE
    AND TO_DATE(:P_PERIOD, 'DDMMYYYY') BETWEEN POPM.EFFECTIVE_START_DATE AND POPM.EFFECTIVE_END_DATE
    AND TO_DATE(:P_PERIOD, 'DDMMYYYY') BETWEEN PCPV.PERIOD_START_DATE(+) AND PCPV.PERIOD_END_DATE(+)
    
    AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PPNF.EFFECTIVE_START_DATE AND PPNF.EFFECTIVE_END_DATE
```

**Key Tables:**
- `PAY_PERSONAL_PAYMENT_METHODS_F` - Personal payment methods
- `PAY_BANK_ACCOUNTS` - Bank account details
- `PAY_ORG_PAY_METHODS_VL` - Organization payment methods
- `PAY_PAYMENT_TYPES_VL` - Payment types
- `PAY_CARD_PAYSLIPS_V` - Payslip view (period, amount)

---

### 6. Payroll Assigned Relationships

**Problem:** Link person to assigned payroll

**Solution:**

```sql
SELECT
    PAPF.PERSON_ID,
    PAPF.PERSON_NUMBER,
    PAP.PAYROLL_NAME,
    PAP.PAYROLL_ID
FROM
    PER_ALL_PEOPLE_F PAPF,
    PAY_PAY_RELATIONSHIPS_DN PPE,
    PAY_REL_GROUPS_DN PRG,
    PAY_ASSIGNED_PAYROLLS_DN PAPD,
    PAY_ALL_PAYROLLS_F PAP
WHERE
    PAPF.PERSON_ID = PPE.PERSON_ID
    AND PPE.PAYROLL_RELATIONSHIP_ID = PRG.PAYROLL_RELATIONSHIP_ID
    AND PRG.RELATIONSHIP_GROUP_ID = PAPD.PAYROLL_TERM_ID
    AND PAPD.PAYROLL_ID = PAP.PAYROLL_ID
    
    AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PAP.EFFECTIVE_START_DATE AND PAP.EFFECTIVE_END_DATE
```

**Alternative (via assignment):**

```sql
SELECT
    PAAF.PERSON_ID,
    PPF.PAYROLL_NAME
FROM
    PER_ALL_ASSIGNMENTS_M PAAF,
    PAY_PAYROLL_ASSIGNMENTS PPA,
    PAY_ASSIGNED_PAYROLLS_DN PAP,
    PAY_ALL_PAYROLLS_F PPF
WHERE
    PAAF.ASSIGNMENT_ID = PPA.HR_ASSIGNMENT_ID
    AND PPA.PAYROLL_TERM_ID = PAP.PAYROLL_TERM_ID
    AND PAP.PAYROLL_ID = PPF.PAYROLL_ID
    
    AND PAAF.ASSIGNMENT_TYPE = 'E'
    AND PAAF.PRIMARY_FLAG = 'Y'
    AND PAAF.EFFECTIVE_LATEST_CHANGE = 'Y'
    
    AND TRUNC(SYSDATE) BETWEEN PAAF.EFFECTIVE_START_DATE AND PAAF.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN PPA.START_DATE AND PPA.END_DATE
    AND TRUNC(SYSDATE) BETWEEN PAP.START_DATE AND PAP.END_DATE
    AND TRUNC(SYSDATE) BETWEEN PPF.EFFECTIVE_START_DATE AND PPF.EFFECTIVE_END_DATE
```

---

### 7. Accrual from Payroll Run (YTD)

**Problem:** Get YTD accrual values from payroll runs

**Solution:**

```sql
SELECT
    PAPF.PERSON_NUMBER,
    
    -- Current month accrual
    (SELECT NVL(TO_NUMBER(PRRV.RESULT_VALUE), 0)
     FROM
         PAY_PAY_RELATIONSHIPS_DN PPRD,
         PAY_PAYROLL_REL_ACTIONS PRA,
         PAY_PAYROLL_ACTIONS PPA,
         PAY_PAYROLL_ASSIGNMENTS PPASG,
         PAY_RUN_RESULTS PRR,
         PAY_RUN_RESULT_VALUES PRRV,
         PAY_ELEMENT_TYPES_TL PET_TL,
         PAY_ELEMENT_TYPES_F PET,
         PAY_INPUT_VALUES_F PIV,
         PAY_INPUT_VALUES_TL PIV_TL
     WHERE
         PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
         AND PRA.RETRO_COMPONENT_ID IS NULL
         AND EXISTS (
             SELECT 1
             FROM PAY_RUN_RESULTS PRR1
             WHERE PRR1.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         )
         AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
         AND PPA.ACTION_TYPE IN ('Q', 'R')
         
         -- Current period only
         AND PPA.DATE_EARNED = :P_DATE
         
         AND PPASG.PAYROLL_RELATIONSHIP_ID = PRA.PAYROLL_RELATIONSHIP_ID
         AND PPA.EFFECTIVE_DATE BETWEEN PPASG.START_DATE AND PPASG.END_DATE
         
         AND PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
         AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         
         -- Annual Leave Salary Accrual element
         AND PET_TL.ELEMENT_NAME = 'Annual Leave Salary Accrual'
         AND PET_TL.LANGUAGE = USERENV('LANG')
         AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
         
         AND PIV.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PIV_TL.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         AND PIV_TL.LANGUAGE = USERENV('LANG')
         AND UPPER(PIV_TL.NAME) = UPPER('Monthly Accrual Amount')
         
         AND PPRD.PERSON_ID = PAPF.PERSON_ID
         
         AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
         AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
         
         AND ROWNUM = 1
    ) MONTHLY_LEAVE_ACCRUAL,
    
    -- YTD accrual
    (SELECT SUM(NVL(TO_NUMBER(PRRV.RESULT_VALUE), 0))
     FROM
         PAY_PAY_RELATIONSHIPS_DN PPRD,
         PAY_PAYROLL_REL_ACTIONS PRA,
         PAY_PAYROLL_ACTIONS PPA,
         PAY_PAYROLL_ASSIGNMENTS PPASG,
         PAY_RUN_RESULTS PRR,
         PAY_RUN_RESULT_VALUES PRRV,
         PAY_ELEMENT_TYPES_TL PET_TL,
         PAY_ELEMENT_TYPES_F PET,
         PAY_INPUT_VALUES_F PIV,
         PAY_INPUT_VALUES_TL PIV_TL
     WHERE
         PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
         AND PRA.RETRO_COMPONENT_ID IS NULL
         AND EXISTS (
             SELECT 1
             FROM PAY_RUN_RESULTS PRR1
             WHERE PRR1.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         )
         AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
         AND PPA.ACTION_TYPE IN ('Q', 'R')
         
         -- YTD: From year start to current date
         AND PPA.DATE_EARNED BETWEEN TRUNC(:P_DATE, 'YEAR') AND :P_DATE
         
         AND PPASG.PAYROLL_RELATIONSHIP_ID = PRA.PAYROLL_RELATIONSHIP_ID
         AND PPA.EFFECTIVE_DATE BETWEEN PPASG.START_DATE AND PPASG.END_DATE
         
         AND PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
         AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         
         AND PET_TL.ELEMENT_NAME = 'Annual Leave Salary Accrual'
         AND PET_TL.LANGUAGE = USERENV('LANG')
         AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
         
         AND PIV.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PIV_TL.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         AND PIV_TL.LANGUAGE = USERENV('LANG')
         AND UPPER(PIV_TL.NAME) = UPPER('Monthly Accrual Amount')
         
         AND PPRD.PERSON_ID = PAPF.PERSON_ID
         
         AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
         AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
    ) LEAVE_ACCRUAL_YTD,
    
    -- Gratuity liability (current month)
    (SELECT NVL(TO_NUMBER(PRRV.RESULT_VALUE), 0)
     FROM
         PAY_PAY_RELATIONSHIPS_DN PPRD,
         PAY_PAYROLL_REL_ACTIONS PRA,
         PAY_PAYROLL_ACTIONS PPA,
         PAY_PAYROLL_ASSIGNMENTS PPASG,
         PAY_RUN_RESULTS PRR,
         PAY_RUN_RESULT_VALUES PRRV,
         PAY_ELEMENT_TYPES_TL PET_TL,
         PAY_ELEMENT_TYPES_F PET,
         PAY_INPUT_VALUES_F PIV,
         PAY_INPUT_VALUES_TL PIV_TL
     WHERE
         PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
         AND PRA.RETRO_COMPONENT_ID IS NULL
         AND EXISTS (
             SELECT 1
             FROM PAY_RUN_RESULTS PRR1
             WHERE PRR1.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         )
         AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
         AND PPA.ACTION_TYPE IN ('Q', 'R')
         AND PPA.DATE_EARNED = :P_DATE
         
         AND PPASG.PAYROLL_RELATIONSHIP_ID = PRA.PAYROLL_RELATIONSHIP_ID
         AND PPA.EFFECTIVE_DATE BETWEEN PPASG.START_DATE AND PPASG.END_DATE
         
         AND PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
         AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         
         -- Gratuity Liability element
         AND PET_TL.ELEMENT_NAME = 'Gratuity Liability'
         AND PET_TL.LANGUAGE = USERENV('LANG')
         AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
         
         AND PIV.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PIV_TL.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         AND PIV_TL.LANGUAGE = USERENV('LANG')
         AND UPPER(PIV_TL.NAME) = UPPER('Monthly Liability Amount')
         
         AND PPRD.PERSON_ID = PAPF.PERSON_ID
         
         AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
         AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
         
         AND ROWNUM = 1
    ) GRATUITY_LIABILITY_MONTHLY,
    
    -- Gratuity YTD
    (SELECT SUM(NVL(TO_NUMBER(PRRV.RESULT_VALUE), 0))
     FROM
         PAY_PAY_RELATIONSHIPS_DN PPRD,
         PAY_PAYROLL_REL_ACTIONS PRA,
         PAY_PAYROLL_ACTIONS PPA,
         PAY_PAYROLL_ASSIGNMENTS PPASG,
         PAY_RUN_RESULTS PRR,
         PAY_RUN_RESULT_VALUES PRRV,
         PAY_ELEMENT_TYPES_TL PET_TL,
         PAY_ELEMENT_TYPES_F PET,
         PAY_INPUT_VALUES_F PIV,
         PAY_INPUT_VALUES_TL PIV_TL
     WHERE
         PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
         AND PRA.RETRO_COMPONENT_ID IS NULL
         AND EXISTS (
             SELECT 1
             FROM PAY_RUN_RESULTS PRR1
             WHERE PRR1.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         )
         AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
         AND PPA.ACTION_TYPE IN ('Q', 'R')
         
         -- YTD
         AND PPA.EFFECTIVE_DATE BETWEEN TRUNC(:P_DATE, 'YEAR') AND :P_DATE
         
         AND PPASG.PAYROLL_RELATIONSHIP_ID = PRA.PAYROLL_RELATIONSHIP_ID
         AND PPA.EFFECTIVE_DATE BETWEEN PPASG.START_DATE AND PPASG.END_DATE
         
         AND PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
         AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         
         AND PET_TL.ELEMENT_NAME = 'Gratuity Liability'
         AND PET_TL.LANGUAGE = USERENV('LANG')
         AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
         
         AND PIV.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PIV_TL.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         AND PIV_TL.LANGUAGE = USERENV('LANG')
         AND UPPER(PIV_TL.NAME) = UPPER('Monthly Liability Amount')
         
         AND PPRD.PERSON_NUMBER = PAPF.PERSON_NUMBER
         
         AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
         AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
    ) GRATUITY_LIABILITY_YTD,
    
    -- Total gratuity balance (inception to date)
    (SELECT NVL(TO_NUMBER(PRRV.RESULT_VALUE), 0)
     FROM
         PAY_PAY_RELATIONSHIPS_DN PPRD,
         PAY_PAYROLL_REL_ACTIONS PRA,
         PAY_PAYROLL_ACTIONS PPA,
         PAY_PAYROLL_ASSIGNMENTS PPASG,
         PAY_RUN_RESULTS PRR,
         PAY_RUN_RESULT_VALUES PRRV,
         PAY_ELEMENT_TYPES_TL PET_TL,
         PAY_ELEMENT_TYPES_F PET,
         PAY_INPUT_VALUES_F PIV,
         PAY_INPUT_VALUES_TL PIV_TL
     WHERE
         PRA.PAYROLL_RELATIONSHIP_ID = PPRD.PAYROLL_RELATIONSHIP_ID
         AND PRA.RETRO_COMPONENT_ID IS NULL
         AND EXISTS (
             SELECT 1
             FROM PAY_RUN_RESULTS PRR1
             WHERE PRR1.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         )
         AND PPA.PAYROLL_ACTION_ID = PRA.PAYROLL_ACTION_ID
         AND PPA.ACTION_TYPE IN ('Q', 'R')
         AND PPA.DATE_EARNED = :P_DATE
         
         AND PPASG.PAYROLL_RELATIONSHIP_ID = PRA.PAYROLL_RELATIONSHIP_ID
         AND PPA.EFFECTIVE_DATE BETWEEN PPASG.START_DATE AND PPASG.END_DATE
         
         AND PRR.PAYROLL_REL_ACTION_ID = PRA.PAYROLL_REL_ACTION_ID
         AND PRR.RUN_RESULT_ID = PRRV.RUN_RESULT_ID
         AND PRR.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PRRV.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         
         AND PET_TL.ELEMENT_NAME = 'Gratuity Liability'
         AND PET_TL.LANGUAGE = USERENV('LANG')
         AND PET.ELEMENT_TYPE_ID = PET_TL.ELEMENT_TYPE_ID
         
         AND PIV.ELEMENT_TYPE_ID = PET.ELEMENT_TYPE_ID
         AND PIV_TL.INPUT_VALUE_ID = PIV.INPUT_VALUE_ID
         AND PIV_TL.LANGUAGE = USERENV('LANG')
         
         -- Total balance (inception to date)
         AND UPPER(PIV_TL.NAME) = UPPER('Total Liability Amount Till Date')
         
         AND PPRD.PERSON_ID = PAPF.PERSON_ID
         
         AND TRUNC(SYSDATE) BETWEEN PET.EFFECTIVE_START_DATE AND PET.EFFECTIVE_END_DATE
         AND TRUNC(SYSDATE) BETWEEN PIV.EFFECTIVE_START_DATE AND PIV.EFFECTIVE_END_DATE
         
         AND ROWNUM = 1
    ) TOTAL_GRATUITY_BALANCE
    
FROM
    PER_ALL_PEOPLE_F PAPF,
    PER_PERIODS_OF_SERVICE PPOS
WHERE
    PAPF.PERSON_ID = PPOS.PERSON_ID
    AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
```

**Common Accrual Elements:**

| Element Name | Input Value | Purpose |
|--------------|-------------|---------|
| Annual Leave Salary Accrual | Monthly Accrual Amount | Monthly leave accrual amount |
| Gratuity Liability | Monthly Liability Amount | Monthly gratuity accrual |
| Gratuity Liability | Total Liability Amount Till Date | Total gratuity balance |
| Person Air Ticket Accrual | (Pay Value) | Self airfare provision |
| Spouse Air Ticket Accruals | (Pay Value) | Spouse airfare provision |
| Child Air Ticket Accruals | (Pay Value) | Children airfare provision |

---

### 8. CTC Reconciliation Pattern

**Problem:** Calculate total cost-to-company including accruals and provisions

**Solution:**

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.FULL_NAME,
    
    -- Basic salary (element entry, not payroll run)
    BASIC_SALARY,
    
    -- Earnings from payroll run
    BASIC_PAY,
    HRA,
    TRANSPORT_ALLOWANCE,
    FOOD_ALLOWANCE,
    OTHER_ALLOWANCE,
    
    -- Overtime
    HOLIDAY_OVERTIME,
    NORMAL_OVERTIME,
    WEEKEND_OVERTIME,
    
    -- One-time
    AIR_TICKET_ENCASEMENT,
    ANNUAL_BONUS,
    ARREARS,
    
    -- Total earnings
    TOTAL_EARNINGS,
    
    -- Deductions
    TOTAL_DEDUCTIONS,
    
    -- Net salary
    (TOTAL_EARNINGS - TOTAL_DEDUCTIONS) NET_SALARY,
    
    -- Provisions (Information elements)
    NVL(PERSON_AIR_TICKET_PROV, 0) PERSON_AIR_TICKET_PROV,
    NVL(SPOUSE_AIR_TICKET_PROV, 0) SPOUSE_AIR_TICKET_PROV,
    NVL(CHILD_AIR_TICKET_PROV, 0) CHILD_AIR_TICKET_PROV,
    NVL(ANNUAL_LEAVE_ACCRUAL, 0) ANNUAL_LEAVE_ACCRUAL_PROV,
    NVL(LEAVE_ACCRUAL_YTD, 0) ANNUAL_LEAVE_ACCRUAL_YTD,
    NVL(GRATUITY_LIABILITY, 0) GRATUITY_LIABILITY,
    NVL(GRATUITY_YTD, 0) GRATUITY_YTD,
    NVL(TOTAL_GRATUITY_BALANCE, 0) GRATUITY_BALANCE,
    
    -- Total CTC (Net Salary + All Provisions)
    (NET_SALARY +
     NVL(PERSON_AIR_TICKET_PROV, 0) +
     NVL(SPOUSE_AIR_TICKET_PROV, 0) +
     NVL(CHILD_AIR_TICKET_PROV, 0) +
     NVL(GRATUITY_LIABILITY, 0) +
     NVL(ANNUAL_LEAVE_ACCRUAL, 0)) TOTAL_COST_TO_COMPANY,
    
    -- Payment details
    EMP_BRANCH,
    SALARY_TYPE,
    IBAN,
    BANK_NAME
    
FROM ...
WHERE ...
```

**CTC Components:**
1. **Direct Compensation** (from payroll run)
   - Basic pay
   - Allowances (housing, transport, food, etc.)
   - Overtime
   - Bonuses
   - Less: Deductions
   = Net Salary

2. **Provisions** (from Information elements)
   - Airfare provision (self + spouse + children)
   - Annual leave accrual
   - Gratuity liability

3. **Total CTC** = Net Salary + All Provisions

---

## âœ… KEY PAYROLL PATTERNS

### Filter by Period

```sql
-- Method 1: Last day of month
WHERE TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)) = NVL(TO_DATE(:P_PERIOD, 'DDMMYYYY'), TRUNC(LAST_DAY(PPA.EFFECTIVE_DATE)))

-- Method 2: Date earned
WHERE PPA.DATE_EARNED = :P_DATE

-- Method 3: Year-to-date
WHERE PPA.DATE_EARNED BETWEEN TRUNC(:P_DATE, 'YEAR') AND :P_DATE
```

### Essential Filters

```sql
WHERE
    -- Action type
    PPA.ACTION_TYPE IN ('Q', 'R')  -- QuickPay or Regular
    
    -- Action status
    PPA.ACTION_STATUS = 'C'  -- Complete
    
    -- Exclude retro
    PPRA.RETRO_COMPONENT_ID IS NULL
    
    -- Pay value input
    UPPER(TRIM(PIVF.BASE_NAME)) = 'PAY VALUE'
    
    -- Element not result type
    PETF.BASE_ELEMENT_NAME NOT LIKE '%Results'  -- For earnings
    PETF.BASE_ELEMENT_NAME LIKE '%Results'      -- For deductions
```

---

**END OF PAYROLL ADVANCED PATTERNS**

**Status:** Production-Ready  
**Date:** 07-Jan-2026  
**Integration:** Integrate with existing PAY_MASTER.md  
**Next Steps:** Update PAY_REPOSITORIES_UPDATE and PAY_TEMPLATES
