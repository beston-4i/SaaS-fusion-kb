# Oracle Time & Labor (OTL) - Query Templates Library

**Purpose:** Copy-paste ready query templates for common OTL scenarios  
**Date:** 07-Jan-2026  
**Status:** Production-Ready

---

## ðŸ“‹ TEMPLATE INDEX

1. [Basic Attendance Report](#template-1-basic-attendance-report)
2. [Monthly Summary](#template-2-monthly-attendance-summary)
3. [Shift Allowance Calculation](#template-3-shift-allowance-calculation)
4. [Missing Punch Report](#template-4-missing-punch-report)
5. [Project Time Report](#template-5-project-time-report)
6. [Late/Early Report](#template-6-late-early-report)
7. [Exception/Regularization Report](#template-7-exception-regularization-report)
8. [Week-off & Holiday Report](#template-8-week-off-holiday-report)

---

## TEMPLATE 1: Basic Attendance Report

**Use Case:** Daily present/absent status with punch times

```sql
WITH PERSON_DETAILS AS (
    SELECT
        PAPF.PERSON_ID,
        PAPF.PERSON_NUMBER,
        PPNF.DISPLAY_NAME,
        PAAF.ASSIGNMENT_ID,
        PSA.SCHEDULE_ID,
        PSA.START_DATE,
        PSA.END_DATE
    FROM
        PER_ALL_PEOPLE_F PAPF,
        PER_PERSON_NAMES_F PPNF,
        PER_ALL_ASSIGNMENTS_F PAAF,
        PER_SCHEDULE_ASSIGNMENTS PSA
    WHERE
        PAPF.PERSON_ID = PPNF.PERSON_ID
        AND PAPF.PERSON_ID = PAAF.PERSON_ID
        AND PAAF.ASSIGNMENT_ID = PSA.RESOURCE_ID
        AND PSA.RESOURCE_TYPE = 'ASSIGN'
        AND PSA.PRIMARY_FLAG = 'Y'
        AND PPNF.NAME_TYPE = 'GLOBAL'
        AND PAAF.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
        AND PAAF.ASSIGNMENT_TYPE = 'E'
        AND PAAF.PRIMARY_ASSIGNMENT_FLAG = 'Y'
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) AND TRUNC(PPNF.EFFECTIVE_END_DATE)
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) AND TRUNC(PAAF.EFFECTIVE_END_DATE)
)
SELECT
    PER.PERSON_NUMBER,
    PER.DISPLAY_NAME,
    TRUNC(HTREV.TE_START_TIME) ATTENDANCE_DATE,
    TO_CHAR(HTREV.TE_START_TIME, 'HH24:MI') PUNCH_IN,
    TO_CHAR(HTREV.TE_STOP_TIME, 'HH24:MI') PUNCH_OUT,
    ROUND(HTREV.TE_MEASURE, 2) WORK_HOURS,
    HTDTUSV.STATUS_VALUE STATUS,
    CASE
        WHEN HTREV.TE_START_TIME IS NOT NULL AND HTREV.TE_STOP_TIME IS NOT NULL THEN 'Present'
        WHEN HTREV.TE_START_TIME IS NULL THEN 'Missing IN'
        WHEN HTREV.TE_STOP_TIME IS NULL THEN 'Missing OUT'
    END REMARKS
FROM
    PERSON_DETAILS PER,
    HWM_TM_RPT_ENTRY_V HTREV,
    HWM_TM_D_TM_UI_STATUS_V HTDTUSV
WHERE
    PER.ASSIGNMENT_ID = HTREV.TE_SUBRESOURCE_ID
    AND HTREV.TC_TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
    AND HTREV.TE_LATEST_VERSION = 'Y'
    AND HTREV.TE_DELETE_FLAG IS NULL
    AND HTREV.TE_LAYER_CODE = 'TIME_RPTD'
    
    -- CRITICAL: Get latest punch for the day
    AND HTREV.TE_CREATION_DATE = (
        SELECT MAX(TE_CREATION_DATE)
        FROM HWM_TM_RPT_ENTRY_V
        WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
        AND RESOURCE_ID = HTREV.RESOURCE_ID
        AND TE_LAYER_CODE = 'TIME_RPTD'
        AND TE_DELETE_FLAG IS NULL
    )
    
    -- Date filter
    AND TRUNC(HTREV.TE_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
    
ORDER BY PER.PERSON_NUMBER, TRUNC(HTREV.TE_START_TIME);
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 2: Monthly Attendance Summary

**Use Case:** Total scheduled days, worked days, absent days, hours worked

```sql
WITH PERSON_DETAILS AS (
    -- Same as Template 1
),
SCHEDULED_DAYS AS (
    SELECT
        PER.PERSON_ID,
        COUNT(DISTINCT TRUNC(ZSSTD.START_DATE_TIME)) TOTAL_SCHEDULED_DAYS,
        SUM(ZSSV.DURATION_MS_NUM / 3600000) TOTAL_SCHEDULED_HOURS
    FROM
        PERSON_DETAILS PER,
        ZMM_SR_SCHEDULE_DTLS ZSSTD,
        ZMM_SR_SHIFTS_VL ZSSV
    WHERE
        PER.SCHEDULE_ID = ZSSTD.SCHEDULE_ID
        AND ZSSTD.SHIFT_ID = ZSSV.SHIFT_ID
        AND TRUNC(ZSSTD.START_DATE_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
        AND TRUNC(ZSSTD.START_DATE_TIME) BETWEEN TRUNC(PER.START_DATE) AND TRUNC(PER.END_DATE)
    GROUP BY PER.PERSON_ID
),
WORKED_DAYS AS (
    SELECT
        HTREV.RESOURCE_ID PERSON_ID,
        COUNT(DISTINCT TRUNC(HTREV.DAY_START_TIME)) TOTAL_WORKED_DAYS,
        ROUND(SUM(HTREV.TE_MEASURE), 2) TOTAL_WORKED_HOURS
    FROM
        HWM_TM_RPT_ENTRY_V HTREV
    WHERE
        HTREV.TE_LATEST_VERSION = 'Y'
        AND HTREV.TE_DELETE_FLAG IS NULL
        AND HTREV.TE_LAYER_CODE = 'TIME_RPTD'
        AND TRUNC(HTREV.DAY_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
        
        -- Exclude missing punches
        AND (TO_CHAR(HTREV.TE_START_TIME, 'HH24') <> '00' OR TO_CHAR(HTREV.TE_START_TIME, 'MI') <> '00')
        AND (TO_CHAR(HTREV.TE_STOP_TIME, 'HH24') <> '00' OR TO_CHAR(HTREV.TE_STOP_TIME, 'MI') <> '00')
        
        AND HTREV.TE_CREATION_DATE = (
            SELECT MAX(TE_CREATION_DATE)
            FROM HWM_TM_RPT_ENTRY_V
            WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
            AND RESOURCE_ID = HTREV.RESOURCE_ID
            AND TE_LAYER_CODE = 'TIME_RPTD'
            AND TE_DELETE_FLAG IS NULL
        )
    GROUP BY HTREV.RESOURCE_ID
),
WEEKOFF_DAYS AS (
    SELECT
        PER.PERSON_ID,
        COUNT(ZSAD.CALENDAR_DATE) WEEKOFF_COUNT
    FROM
        PERSON_DETAILS PER,
        ZMM_SR_AVAILABLE_DATES ZSAD
    WHERE
        PER.SCHEDULE_ID = ZSAD.SCHEDULE_ID
        AND ZSAD.SEQ_NUM IS NULL
        AND ZSAD.CALENDAR_DATE BETWEEN :P_FROM_DATE AND :P_TO_DATE
        AND ZSAD.CALENDAR_DATE BETWEEN TRUNC(PER.START_DATE) AND TRUNC(PER.END_DATE)
    GROUP BY PER.PERSON_ID
),
PUBLIC_HOLIDAYS AS (
    SELECT
        PAPF.PERSON_ID,
        COUNT(DISTINCT TRUNC(CAL.CALENDAR_DATE)) HOLIDAY_COUNT
    FROM
        PER_ALL_PEOPLE_F PAPF,
        PER_ALL_ASSIGNMENTS_F PAAF,
        PER_SCHEDULE_ASSIGNMENTS PSA,
        PER_SCHEDULE_EXCEPTIONS PSE,
        PER_CALENDAR_EVENTS PCE,
        PER_GEO_TREE_NODE_RF PNR,
        HR_LOCATIONS HL,
        (SELECT :P_FROM_DATE + ROWNUM - 1 CALENDAR_DATE
         FROM DUAL
         CONNECT BY ROWNUM <= :P_TO_DATE - :P_FROM_DATE + 1) CAL
    WHERE
        PAPF.PERSON_ID = PAAF.PERSON_ID
        AND PAAF.ASSIGNMENT_ID = PSA.RESOURCE_ID
        AND PSA.SCHEDULE_ID = PSE.SCHEDULE_ID
        AND PSE.EXCEPTION_ID = PCE.CALENDAR_EVENT_ID
        AND PCE.CATEGORY = 'PH'
        AND PCE.TREE_CODE = PNR.TREE_CODE
        AND PCE.TREE_STRUCTURE_CODE = PNR.TREE_STRUCTURE_CODE
        AND PAAF.LOCATION_ID = HL.LOCATION_ID
        AND HL.COUNTRY = PNR.PK1_VALUE
        AND TRUNC(CAL.CALENDAR_DATE) BETWEEN TRUNC(PCE.START_DATE_TIME) AND TRUNC(PCE.END_DATE_TIME)
        AND PAAF.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) AND TRUNC(PAAF.EFFECTIVE_END_DATE)
    GROUP BY PAPF.PERSON_ID
),
LEAVE_DAYS AS (
    SELECT
        APAE.PERSON_ID,
        COUNT(DISTINCT CAL.CALENDAR_DATE) LEAVE_COUNT
    FROM
        ANC_PER_ABS_ENTRIES APAE,
        (SELECT :P_FROM_DATE + ROWNUM - 1 CALENDAR_DATE
         FROM DUAL
         CONNECT BY ROWNUM <= :P_TO_DATE - :P_FROM_DATE + 1) CAL
    WHERE
        APAE.APPROVAL_STATUS_CD = 'APPROVED'
        AND APAE.ABSENCE_STATUS_CD <> 'ORA_WITHDRAWN'
        AND TRUNC(CAL.CALENDAR_DATE) BETWEEN TRUNC(APAE.START_DATE) AND TRUNC(APAE.END_DATE)
    GROUP BY APAE.PERSON_ID
)
SELECT
    PER.PERSON_NUMBER,
    PER.DISPLAY_NAME,
    NVL(SD.TOTAL_SCHEDULED_DAYS, 0) TOTAL_SCHEDULED_DAYS,
    NVL(SD.TOTAL_SCHEDULED_HOURS, 0) TOTAL_SCHEDULED_HOURS,
    NVL(WD.TOTAL_WORKED_DAYS, 0) TOTAL_WORKED_DAYS,
    NVL(WD.TOTAL_WORKED_HOURS, 0) TOTAL_WORKED_HOURS,
    NVL(WO.WEEKOFF_COUNT, 0) WEEKOFF_DAYS,
    NVL(PH.HOLIDAY_COUNT, 0) PUBLIC_HOLIDAY_DAYS,
    NVL(LD.LEAVE_COUNT, 0) LEAVE_DAYS,
    (SD.TOTAL_SCHEDULED_DAYS - NVL(WO.WEEKOFF_COUNT, 0) - NVL(PH.HOLIDAY_COUNT, 0) - NVL(WD.TOTAL_WORKED_DAYS, 0) - NVL(LD.LEAVE_COUNT, 0)) ABSENT_DAYS,
    ROUND((NVL(WD.TOTAL_WORKED_DAYS, 0) / NULLIF(SD.TOTAL_SCHEDULED_DAYS - NVL(WO.WEEKOFF_COUNT, 0) - NVL(PH.HOLIDAY_COUNT, 0), 0)) * 100, 2) ATTENDANCE_PCT
FROM
    PERSON_DETAILS PER
    LEFT JOIN SCHEDULED_DAYS SD ON PER.PERSON_ID = SD.PERSON_ID
    LEFT JOIN WORKED_DAYS WD ON PER.PERSON_ID = WD.PERSON_ID
    LEFT JOIN WEEKOFF_DAYS WO ON PER.PERSON_ID = WO.PERSON_ID
    LEFT JOIN PUBLIC_HOLIDAYS PH ON PER.PERSON_ID = PH.PERSON_ID
    LEFT JOIN LEAVE_DAYS LD ON PER.PERSON_ID = LD.PERSON_ID
ORDER BY PER.PERSON_NUMBER;
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 3: Shift Allowance Calculation

**Use Case:** Identify night/evening shift days eligible for allowance

```sql
WITH PERSON_DETAILS AS (
    -- Same as Template 1
),
SHIFT_ELIGIBILITY AS (
    SELECT
        PER.PERSON_ID,
        PER.PERSON_NUMBER,
        PER.DISPLAY_NAME,
        TRUNC(HTREV.TE_START_TIME) CALENDAR_DATE,
        HTREV.TE_MEASURE WORK_HRS,
        HTREV.TE_START_TIME PUNCH_IN,
        HTREV.TE_STOP_TIME PUNCH_OUT,
        HTDTUSV.STATUS_VALUE,
        
        -- Shift times
        ZSSV.DURATION_MS_NUM / 3600000 SHIFT_DURATION,
        
        -- Build shift start datetime
        CASE
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 >= 24
            THEN TO_DATE(TO_CHAR(TRUNC(HTREV.TE_START_TIME) + 1, 'YYYY-MM-DD') || ' ' ||
                        LPAD(TRUNC(ZSSV.START_TIME_MS_NUM / 3600000) - 24, 2, '0') || ':' ||
                        LPAD(TRUNC(MOD(ROUND(ZSSV.START_TIME_MS_NUM / 1000), 3600) / 60), 2, '0'),
                        'YYYY-MM-DD HH24:MI')
            ELSE TO_DATE(TO_CHAR(TRUNC(HTREV.TE_START_TIME), 'YYYY-MM-DD') || ' ' ||
                        LPAD(TRUNC(ZSSV.START_TIME_MS_NUM / 3600000), 2, '0') || ':' ||
                        LPAD(TRUNC(MOD(ROUND(ZSSV.START_TIME_MS_NUM / 1000), 3600) / 60), 2, '0'),
                        'YYYY-MM-DD HH24:MI')
        END START_DATE_TIME,
        
        -- Build shift end datetime
        CASE
            WHEN ZSSV.END_TIME_MS_NUM / 3600000 >= 24
            THEN TO_DATE(TO_CHAR(TRUNC(HTREV.TE_START_TIME) + 1, 'YYYY-MM-DD') || ' ' ||
                        LPAD(TRUNC(ZSSV.END_TIME_MS_NUM / 3600000) - 24, 2, '0') || ':' ||
                        LPAD(TRUNC(MOD(ROUND(ZSSV.END_TIME_MS_NUM / 1000), 3600) / 60), 2, '0'),
                        'YYYY-MM-DD HH24:MI')
            ELSE TO_DATE(TO_CHAR(TRUNC(HTREV.TE_START_TIME), 'YYYY-MM-DD') || ' ' ||
                        LPAD(TRUNC(ZSSV.END_TIME_MS_NUM / 3600000), 2, '0') || ':' ||
                        LPAD(TRUNC(MOD(ROUND(ZSSV.END_TIME_MS_NUM / 1000), 3600) / 60), 2, '0'),
                        'YYYY-MM-DD HH24:MI')
        END END_DATE_TIME,
        
        -- Classify shift type
        CASE
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 BETWEEN 18 AND 28
             OR ZSSV.START_TIME_MS_NUM / 3600000 BETWEEN 0 AND 4
            THEN 'night shift'
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 BETWEEN 13 AND 17.5
            THEN 'Evening Shift'
            ELSE 'Regular'
        END SHIFT_TYPE
        
    FROM
        PERSON_DETAILS PER,
        HWM_TM_RPT_ENTRY_V HTREV,
        HWM_TM_D_TM_UI_STATUS_V HTDTUSV,
        ZMM_SR_SCHEDULES_VL ZSSS,
        ZMM_SR_SCHEDULE_PATTERNS ZSSP,
        ZMM_SR_PATTERN_DTLS ZSPD,
        ZMM_SR_SCHEDULE_DTLS ZSSTD,
        ZMM_SR_SHIFTS_VL ZSSV
    WHERE
        PER.ASSIGNMENT_ID = HTREV.TE_SUBRESOURCE_ID
        AND HTREV.TC_TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
        AND PER.SCHEDULE_ID = ZSSS.SCHEDULE_ID
        AND ZSSS.SCHEDULE_ID = ZSSP.SCHEDULE_ID
        AND ZSSP.PATTERN_ID = ZSPD.PATTERN_ID
        AND ZSPD.CHILD_SHIFT_ID = ZSSV.SHIFT_ID
        AND ZSSS.SCHEDULE_ID = ZSSTD.SCHEDULE_ID
        AND ZSSV.SHIFT_ID = ZSSTD.SHIFT_ID
        AND HTREV.TE_LATEST_VERSION = 'Y'
        AND HTREV.TE_DELETE_FLAG IS NULL
        AND HTREV.TE_LAYER_CODE = 'TIME_RPTD'
        AND TRUNC(HTREV.TE_START_TIME) = TRUNC(ZSSTD.START_DATE_TIME)
        AND TRUNC(HTREV.TE_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
        AND HTREV.TE_CREATION_DATE = (
            SELECT MAX(TE_CREATION_DATE)
            FROM HWM_TM_RPT_ENTRY_V
            WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
            AND RESOURCE_ID = HTREV.RESOURCE_ID
            AND TE_LAYER_CODE = 'TIME_RPTD'
            AND TE_DELETE_FLAG IS NULL
        )
)
SELECT
    PERSON_NUMBER,
    DISPLAY_NAME,
    CALENDAR_DATE,
    SHIFT_TYPE,
    WORK_HRS,
    SHIFT_DURATION,
    
    -- Eligibility check
    CASE
        WHEN SHIFT_TYPE IN ('night shift', 'Evening Shift')
         AND SHIFT_DURATION <= WORK_HRS
         AND PUNCH_IN <= START_DATE_TIME
         AND PUNCH_OUT >= END_DATE_TIME
         AND STATUS_VALUE = 'APPROVED'
        THEN 'Y'
        ELSE 'N'
    END ELIGIBLE,
    
    STATUS_VALUE
    
FROM SHIFT_ELIGIBILITY
WHERE SHIFT_TYPE IN ('night shift', 'Evening Shift')
ORDER BY PERSON_NUMBER, CALENDAR_DATE;
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 4: Missing Punch Report

**Use Case:** Identify missing punch IN or OUT

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.DISPLAY_NAME,
    TRUNC(HTREV.TE_START_TIME) PUNCH_DATE,
    
    -- Detect missing IN
    CASE
        WHEN EXTRACT(HOUR FROM HTREV.TE_START_TIME) = 0
         AND EXTRACT(MINUTE FROM HTREV.TE_START_TIME) = 0
         AND EXTRACT(SECOND FROM HTREV.TE_START_TIME) = 0
        THEN 'NOT AVAILABLE'
        ELSE TO_CHAR(HTREV.TE_START_TIME, 'HH24:MI')
    END PUNCH_IN,
    
    -- Detect missing OUT
    CASE
        WHEN TRUNC(HTREV.TE_STOP_TIME) IS NULL
        THEN 'NOT AVAILABLE'
        ELSE TO_CHAR(HTREV.TE_STOP_TIME, 'HH24:MI')
    END PUNCH_OUT,
    
    HTDTUSV.STATUS_VALUE,
    
    -- Remark
    CASE
        WHEN PUNCH_IN = 'NOT AVAILABLE' THEN 'Missing IN'
        WHEN PUNCH_OUT = 'NOT AVAILABLE' THEN 'Missing OUT'
    END REMARKS
    
FROM
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    PER_ALL_ASSIGNMENTS_F PAAF,
    HWM_TM_RPT_ENTRY_V HTREV,
    HWM_TM_D_TM_UI_STATUS_V HTDTUSV
WHERE
    PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = PAAF.PERSON_ID
    AND PAAF.ASSIGNMENT_ID = HTREV.TE_SUBRESOURCE_ID
    AND HTREV.TC_TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
    AND HTREV.TE_LATEST_VERSION = 'Y'
    AND HTREV.TE_DELETE_FLAG IS NULL
    AND PPNF.NAME_TYPE = 'GLOBAL'
    AND PAAF.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
    
    -- Filter for missing punches
    AND (TRUNC(HTREV.TE_STOP_TIME) IS NULL
         OR (EXTRACT(HOUR FROM HTREV.TE_START_TIME) = 0
             AND EXTRACT(MINUTE FROM HTREV.TE_START_TIME) = 0
             AND EXTRACT(SECOND FROM HTREV.TE_START_TIME) = 0))
    
    -- Status indicates incomplete
    AND HTDTUSV.STATUS_VALUE IN ('INCOMPLETE', 'IN_ERROR')
    
    -- Date filter
    AND TRUNC(HTREV.TE_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
    
    -- Latest version for the day
    AND HTREV.TE_CREATION_DATE = (
        SELECT MAX(TE_CREATION_DATE)
        FROM HWM_TM_RPT_ENTRY_V
        WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
        AND RESOURCE_ID = HTREV.RESOURCE_ID
        AND TE_DELETE_FLAG IS NULL
    )
    
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) AND TRUNC(PPNF.EFFECTIVE_END_DATE)
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) AND TRUNC(PAAF.EFFECTIVE_END_DATE)
    
ORDER BY PAPF.PERSON_NUMBER, TRUNC(HTREV.TE_START_TIME);
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 5: Project Time Report

**Use Case:** Hours worked per project/task

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.DISPLAY_NAME,
    TO_CHAR(DTRG1.START_TIME, 'DD-MM-YYYY') WEEK_START,
    TO_CHAR(DTRG1.STOP_TIME, 'DD-MM-YYYY') WEEK_END,
    PPAV.SEGMENT1 PROJECT_NUMBER,
    PPAV.NAME PROJECT_NAME,
    PTV.TASK_NUMBER,
    PTV.TASK_NAME,
    HTR.MEASURE HOURS,
    HTDTUSV.STATUS_VALUE STATUS
FROM
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    HWM_TM_REC HTR,
    HWM_TM_REC_GRP_USAGES HTRGU,
    HWM_TM_REC_GRP DTRG,
    HWM_TM_REC_GRP DTRG1,
    HWM_TM_D_TM_UI_STATUS_V HTDTUSV,
    HWM_TM_REP_S_PJC_ATRBS_V HTRPA,
    PJF_PROJECTS_ALL_VL PPAV,
    PJF_TASKS_V PTV
WHERE
    PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = HTR.RESOURCE_ID
    AND HTR.TM_REC_ID = HTRGU.TM_REC_ID
    AND HTR.TM_REC_VERSION = HTRGU.TM_REC_VERSION
    AND HTRGU.TM_REC_GRP_ID = DTRG.TM_REC_GRP_ID
    AND HTRGU.TM_REC_GRP_VERSION = DTRG.TM_REC_GRP_VERSION
    AND DTRG.PARENT_TM_REC_GRP_ID = DTRG1.TM_REC_GRP_ID
    AND DTRG.PARENT_TM_REC_GRP_VERSION = DTRG1.TM_REC_GRP_VERSION
    AND DTRG1.TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
    AND HTR.TM_REC_ID = HTRPA.USAGES_SOURCE_ID
    AND HTR.TM_REC_VERSION = HTRPA.USAGES_SOURCE_VERSION
    AND HTRPA.PJC_PROJECT_ID = PPAV.PROJECT_ID
    AND HTRPA.PJC_TASK_ID = PTV.TASK_ID
    AND HTR.LAYER_CODE = 'TIME_RPTD'
    AND HTR.LATEST_VERSION = 'Y'
    AND HTR.DELETE_FLAG IS NULL
    AND UPPER(HTR.UNIT_OF_MEASURE) IN ('UN', 'HR')
    AND DTRG1.GRP_TYPE_ID = 100
    AND PPNF.NAME_TYPE = 'GLOBAL'
    AND TRUNC(HTR.LAST_UPDATE_DATE) BETWEEN :P_FROM_DATE AND :P_TO_DATE
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) AND TRUNC(PPNF.EFFECTIVE_END_DATE)
ORDER BY PAPF.PERSON_NUMBER, DTRG1.START_TIME, PPAV.SEGMENT1;
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 6: Late/Early Report

**Use Case:** Track late arrivals and early departures

```sql
WITH PERSON_DETAILS AS (
    -- Same as Template 1
),
SHIFT_TIMING AS (
    SELECT
        PER.PERSON_ID,
        PER.PERSON_NUMBER,
        PER.DISPLAY_NAME,
        TRUNC(HTREV.TE_START_TIME) ATTENDANCE_DATE,
        HTREV.TE_START_TIME PUNCH_IN,
        HTREV.TE_STOP_TIME PUNCH_OUT,
        ZSSV.START_TIME_MS_NUM / 3600000 SHIFT_START_HOUR,
        ZSSV.END_TIME_MS_NUM / 3600000 SHIFT_END_HOUR,
        
        -- Calculate late hours
        CASE
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 > EXTRACT(HOUR FROM HTREV.TE_START_TIME) THEN 0
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 = EXTRACT(HOUR FROM HTREV.TE_START_TIME)
                 AND EXTRACT(MINUTE FROM HTREV.TE_START_TIME) <= 30 THEN 0
            ELSE EXTRACT(HOUR FROM HTREV.TE_START_TIME) - ZSSV.START_TIME_MS_NUM / 3600000
        END LATE_HOURS,
        
        -- Calculate late minutes
        CASE
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 > EXTRACT(HOUR FROM HTREV.TE_START_TIME) THEN 0
            WHEN ZSSV.START_TIME_MS_NUM / 3600000 = EXTRACT(HOUR FROM HTREV.TE_START_TIME)
            THEN CASE
                WHEN EXTRACT(MINUTE FROM HTREV.TE_START_TIME) <= 30 THEN 0
                ELSE EXTRACT(MINUTE FROM HTREV.TE_START_TIME)
            END
            ELSE EXTRACT(MINUTE FROM HTREV.TE_START_TIME)
        END LATE_MINUTES,
        
        -- Calculate early hours
        CASE
            WHEN EXTRACT(HOUR FROM HTREV.TE_STOP_TIME) = ZSSV.END_TIME_MS_NUM / 3600000 THEN 0
            WHEN ZSSV.END_TIME_MS_NUM / 3600000 - EXTRACT(HOUR FROM HTREV.TE_STOP_TIME) > 1
            THEN ZSSV.END_TIME_MS_NUM / 3600000 - EXTRACT(HOUR FROM HTREV.TE_STOP_TIME)
            ELSE 0
        END EARLY_HOURS,
        
        -- Calculate early minutes
        CASE
            WHEN EXTRACT(HOUR FROM HTREV.TE_STOP_TIME) = ZSSV.END_TIME_MS_NUM / 3600000 THEN 0
            WHEN EXTRACT(HOUR FROM HTREV.TE_STOP_TIME) < ZSSV.END_TIME_MS_NUM / 3600000
            THEN CASE
                WHEN EXTRACT(MINUTE FROM HTREV.TE_STOP_TIME) = 0 THEN 0
                ELSE 60 - EXTRACT(MINUTE FROM HTREV.TE_STOP_TIME)
            END
            ELSE 0
        END EARLY_MINUTES
        
    FROM
        PERSON_DETAILS PER,
        HWM_TM_RPT_ENTRY_V HTREV,
        HWM_TM_D_TM_UI_STATUS_V HTDTUSV,
        ZMM_SR_SCHEDULES_VL ZSSS,
        ZMM_SR_SCHEDULE_PATTERNS ZSSP,
        ZMM_SR_PATTERN_DTLS ZSPD,
        ZMM_SR_SCHEDULE_DTLS ZSSTD,
        ZMM_SR_SHIFTS_VL ZSSV
    WHERE
        PER.ASSIGNMENT_ID = HTREV.TE_SUBRESOURCE_ID
        AND HTREV.TC_TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
        AND PER.SCHEDULE_ID = ZSSS.SCHEDULE_ID
        AND ZSSS.SCHEDULE_ID = ZSSP.SCHEDULE_ID
        AND ZSSP.PATTERN_ID = ZSPD.PATTERN_ID
        AND ZSPD.CHILD_SHIFT_ID = ZSSV.SHIFT_ID
        AND ZSSS.SCHEDULE_ID = ZSSTD.SCHEDULE_ID
        AND ZSSV.SHIFT_ID = ZSSTD.SHIFT_ID
        AND HTREV.TE_LATEST_VERSION = 'Y'
        AND HTREV.TE_DELETE_FLAG IS NULL
        AND HTREV.TE_LAYER_CODE = 'TIME_RPTD'
        AND TRUNC(HTREV.TE_START_TIME) = TRUNC(ZSSTD.START_DATE_TIME)
        AND TRUNC(HTREV.TE_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
        AND HTREV.TE_CREATION_DATE = (
            SELECT MAX(TE_CREATION_DATE)
            FROM HWM_TM_RPT_ENTRY_V
            WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
            AND RESOURCE_ID = HTREV.RESOURCE_ID
            AND TE_LAYER_CODE = 'TIME_RPTD'
            AND TE_DELETE_FLAG IS NULL
        )
)
SELECT
    PERSON_NUMBER,
    DISPLAY_NAME,
    ATTENDANCE_DATE,
    TO_CHAR(PUNCH_IN, 'HH24:MI') PUNCH_IN,
    TO_CHAR(PUNCH_OUT, 'HH24:MI') PUNCH_OUT,
    LPAD(LATE_HOURS, 2, '0') || ':' || LPAD(LATE_MINUTES, 2, '0') LATE_BY,
    LPAD(EARLY_HOURS, 2, '0') || ':' || LPAD(EARLY_MINUTES, 2, '0') EARLY_BY,
    CASE
        WHEN LATE_HOURS > 0 OR LATE_MINUTES > 0 THEN 'Late'
        WHEN EARLY_HOURS > 0 OR EARLY_MINUTES > 0 THEN 'Early'
        ELSE 'On Time'
    END STATUS
FROM SHIFT_TIMING
WHERE LATE_HOURS > 0 OR LATE_MINUTES > 0 OR EARLY_HOURS > 0 OR EARLY_MINUTES > 0
ORDER BY PERSON_NUMBER, ATTENDANCE_DATE;
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 7: Exception/Regularization Report

**Use Case:** Track regularization requests for missing punches

```sql
SELECT
    PAPF.PERSON_NUMBER,
    PPNF.DISPLAY_NAME,
    TRUNC(HTREV.TE_START_TIME) EXCEPTION_DATE,
    HTDTUSV.STATUS_VALUE TIMECARD_STATUS,
    
    -- Punch times (may be regularized)
    CASE
        WHEN HTDTUSV.STATUS_VALUE IN ('INCOMPLETE', 'ENTERED')
         OR HTRCR.STATUS IN (0, 4, 1)
        THEN TO_CHAR(HTREV.TE_START_TIME, 'HH24:MI')
        ELSE NULL
    END SIGN_IN,
    
    CASE
        WHEN HTDTUSV.STATUS_VALUE IN ('IN_ERROR', 'ENTERED')
        THEN TO_CHAR(HTREV.TE_STOP_TIME, 'HH24:MI')
        ELSE NULL
    END SIGN_OUT,
    
    -- Regularization request
    CASE
        WHEN HTRCR.STATUS IN (0, 4, 1)
        THEN TRUNC(HTRCR.SUBMISSION_DATE)
        ELSE NULL
    END REQUEST_DATE,
    
    CASE
        WHEN HTRCR.STATUS IN (4, 1)
        THEN TRUNC(HTRCR.LAST_UPDATE_DATE)
        ELSE NULL
    END APPROVE_DATE,
    
    -- Request status
    CASE
        WHEN HTRCR.STATUS = 0 THEN 'Pending Approval'
        WHEN HTRCR.STATUS IN (1, 4) THEN 'Approved'
        WHEN HTRCR.STATUS = 3 THEN 'Rejected'
        ELSE 'Not Requested'
    END REQUEST_STATUS,
    
    -- Exception type
    CASE
        WHEN SIGN_IN IS NULL THEN 'Missing IN Regularised'
        WHEN SIGN_OUT IS NULL THEN 'Missing OUT Regularised'
        ELSE 'Other Exception'
    END EXCEPTION_TYPE
    
FROM
    PER_ALL_PEOPLE_F PAPF,
    PER_PERSON_NAMES_F PPNF,
    PER_ALL_ASSIGNMENTS_F PAAF,
    HWM_TM_RPT_ENTRY_V HTREV,
    HWM_TM_D_TM_UI_STATUS_V HTDTUSV,
    HWM_TM_REC_CHANGES HTRC,
    HWM_TM_REC_CHANGE_REQS HTRCR
WHERE
    PAPF.PERSON_ID = PPNF.PERSON_ID
    AND PAPF.PERSON_ID = PAAF.PERSON_ID
    AND PAAF.ASSIGNMENT_ID = HTREV.TE_SUBRESOURCE_ID
    AND HTREV.TC_TM_REC_GRP_ID = HTDTUSV.TM_BLDG_BLK_ID
    AND HTREV.TE_TM_REC_ID = HTRC.TM_REC_ID(+)
    AND HTRC.TM_REC_CHANGE_REQ_ID = HTRCR.TM_REC_CHANGE_REQ_ID(+)
    
    -- Only exception timecards
    AND HTDTUSV.STATUS_VALUE IN ('IN_ERROR', 'INCOMPLETE', 'ENTERED')
    
    -- Exclude rejected (optional)
    AND HTRCR.STATUS(+) <> 3
    
    AND HTREV.TE_LATEST_VERSION = 'Y'
    AND HTREV.TE_DELETE_FLAG IS NULL
    AND PPNF.NAME_TYPE = 'GLOBAL'
    AND PAAF.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
    AND TRUNC(HTREV.TE_START_TIME) BETWEEN :P_FROM_DATE AND :P_TO_DATE
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) AND TRUNC(PPNF.EFFECTIVE_END_DATE)
    AND TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) AND TRUNC(PAAF.EFFECTIVE_END_DATE)
    
ORDER BY PAPF.PERSON_NUMBER, TRUNC(HTREV.TE_START_TIME);
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## TEMPLATE 8: Week-off & Holiday Report

**Use Case:** List all week-offs and public holidays for employees

```sql
WITH PERSON_DETAILS AS (
    -- Same as Template 1
),
WEEKOFFS AS (
    SELECT
        PER.PERSON_ID,
        PER.PERSON_NUMBER,
        PER.DISPLAY_NAME,
        ZSAD.CALENDAR_DATE,
        'Week-off' DAY_TYPE
    FROM
        PERSON_DETAILS PER,
        ZMM_SR_AVAILABLE_DATES ZSAD
    WHERE
        PER.SCHEDULE_ID = ZSAD.SCHEDULE_ID
        AND ZSAD.SEQ_NUM IS NULL
        AND ZSAD.CALENDAR_DATE BETWEEN :P_FROM_DATE AND :P_TO_DATE
        AND ZSAD.CALENDAR_DATE BETWEEN TRUNC(PER.START_DATE) AND TRUNC(PER.END_DATE)
),
PUBLIC_HOLIDAYS AS (
    SELECT
        PAPF.PERSON_ID,
        PAPF.PERSON_NUMBER,
        PPNF.DISPLAY_NAME,
        TRUNC(CAL.CALENDAR_DATE) CALENDAR_DATE,
        'Public Holiday' DAY_TYPE
    FROM
        PER_ALL_PEOPLE_F PAPF,
        PER_PERSON_NAMES_F PPNF,
        PER_ALL_ASSIGNMENTS_F PAAF,
        PER_SCHEDULE_ASSIGNMENTS PSA,
        PER_SCHEDULE_EXCEPTIONS PSE,
        PER_CALENDAR_EVENTS PCE,
        PER_GEO_TREE_NODE_RF PNR,
        HR_LOCATIONS HL,
        (SELECT :P_FROM_DATE + ROWNUM - 1 CALENDAR_DATE
         FROM DUAL
         CONNECT BY ROWNUM <= :P_TO_DATE - :P_FROM_DATE + 1) CAL
    WHERE
        PAPF.PERSON_ID = PPNF.PERSON_ID
        AND PAPF.PERSON_ID = PAAF.PERSON_ID
        AND PAAF.ASSIGNMENT_ID = PSA.RESOURCE_ID
        AND PSA.SCHEDULE_ID = PSE.SCHEDULE_ID
        AND PSE.EXCEPTION_ID = PCE.CALENDAR_EVENT_ID
        AND PCE.CATEGORY = 'PH'
        AND PCE.TREE_CODE = PNR.TREE_CODE
        AND PCE.TREE_STRUCTURE_CODE = PNR.TREE_STRUCTURE_CODE
        AND PAAF.LOCATION_ID = HL.LOCATION_ID
        AND HL.COUNTRY = PNR.PK1_VALUE
        AND TRUNC(CAL.CALENDAR_DATE) BETWEEN TRUNC(PCE.START_DATE_TIME) AND TRUNC(PCE.END_DATE_TIME)
        AND PPNF.NAME_TYPE = 'GLOBAL'
        AND PAAF.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) AND TRUNC(PAPF.EFFECTIVE_END_DATE)
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) AND TRUNC(PPNF.EFFECTIVE_END_DATE)
        AND TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) AND TRUNC(PAAF.EFFECTIVE_END_DATE)
)
SELECT
    PERSON_NUMBER,
    DISPLAY_NAME,
    CALENDAR_DATE,
    TO_CHAR(CALENDAR_DATE, 'DAY', 'NLS_DATE_LANGUAGE = AMERICAN') DAY_NAME,
    DAY_TYPE
FROM (
    SELECT * FROM WEEKOFFS
    UNION ALL
    SELECT * FROM PUBLIC_HOLIDAYS
)
ORDER BY PERSON_NUMBER, CALENDAR_DATE;
```

**Parameters:**
- `:P_FROM_DATE` - Start date
- `:P_TO_DATE` - End date

---

## ðŸŽ¯ QUICK REFERENCE: Common Subqueries

### Get Latest Punch for Day
```sql
AND HTREV.TE_CREATION_DATE = (
    SELECT MAX(TE_CREATION_DATE)
    FROM HWM_TM_RPT_ENTRY_V
    WHERE DAY_TM_REC_GRP_ID = HTREV.DAY_TM_REC_GRP_ID
    AND RESOURCE_ID = HTREV.RESOURCE_ID
    AND TE_LAYER_CODE = 'TIME_RPTD'
    AND TE_DELETE_FLAG IS NULL
)
```

### Get Latest Status
```sql
AND HTDTUSV.STATUS_ID = (
    SELECT MAX(STATUS_ID)
    FROM HWM_TM_D_TM_UI_STATUS_V
    WHERE TM_BLDG_BLK_ID = HTDTUSV.TM_BLDG_BLK_ID
)
```

### Check for Absence
```sql
AND NOT EXISTS (
    SELECT 1
    FROM ANC_PER_ABS_ENTRIES APAE
    WHERE APAE.PERSON_ID = :PERSON_ID
    AND APAE.APPROVAL_STATUS_CD = 'APPROVED'
    AND APAE.ABSENCE_STATUS_CD <> 'ORA_WITHDRAWN'
    AND TRUNC(:DATE) BETWEEN TRUNC(APAE.START_DATE) AND TRUNC(APAE.END_DATE)
)
```

### Check for Week-off
```sql
AND TRUNC(:DATE) IN (
    SELECT CALENDAR_DATE
    FROM ZMM_SR_AVAILABLE_DATES
    WHERE SCHEDULE_ID = :SCHEDULE_ID
    AND SEQ_NUM IS NULL
)
```

### Convert Milliseconds to Hours
```sql
ZSSV.START_TIME_MS_NUM / 3600000 AS SHIFT_START_HOURS
```

---

**END OF QUERY TEMPLATES**

**Status:** Production-Ready  
**Last Updated:** 07-Jan-2026  
**Total Templates:** 8 major scenarios  
**Usage:** Copy template, replace parameters, adjust filters as needed
