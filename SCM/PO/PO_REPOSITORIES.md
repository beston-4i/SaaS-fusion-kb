# Purchasing Repository Patterns

**Purpose:** Standardized CTEs for extracting PO data.

---

## 1. PO Master (Headers & Suppliers)
*Retrieves all PO Headers with Supplier details.*

```sql
PO_MASTER AS (
    SELECT /*+ qb_name(PO_MST) MATERIALIZE */
           PHA.PO_HEADER_ID
          ,PHA.SEGMENT1 AS PO_NUMBER
          ,PHA.TYPE_LOOKUP_CODE
          ,PHA.PRC_BU_ID
          ,POS.VENDOR_NAME
          ,PHA.CURRENCY_CODE
          ,PHA.CREATION_DATE
    FROM   PO_HEADERS_ALL PHA
          ,POZ_SUPPLIERS_V POS
    WHERE  PHA.VENDOR_ID = POS.VENDOR_ID
      AND  (PHA.PRC_BU_ID IN (:P_BU_ID) OR 'All' IN (:P_BU_ID || 'All'))
)
```

---

## 2. Open PO Lines (Shipments)
*Retrieves lines with open quantity to receive.*

```sql
PO_OPEN_LINES AS (
    SELECT /*+ qb_name(PO_OPEN) MATERIALIZE */
           PLLA.PO_HEADER_ID
          ,PLLA.PO_LINE_ID
          ,PLLA.LINE_LOCATION_ID
          ,PLA.ITEM_DESCRIPTION
          ,PLLA.QUANTITY
          ,PLLA.QUANTITY_RECEIVED
          ,PLLA.QUANTITY_BILLED
          ,(PLLA.QUANTITY - NVL(PLLA.QUANTITY_RECEIVED, 0)) AS QTY_REMAINING
    FROM   PO_LINES_ALL PLA
          ,PO_LINE_LOCATIONS_ALL PLLA
    WHERE  PLA.PO_LINE_ID = PLLA.PO_LINE_ID
      AND  NVL(PLLA.CANCEL_FLAG, 'N') = 'N'
      AND  PLLA.CLOSED_CODE NOT IN ('CLOSED', 'FINALLY CLOSED')
)
```

---

## 3. Receiving Master
*Retrieves Receipts and Deliveries.*

```sql
PO_RCV_MASTER AS (
    SELECT /*+ qb_name(RCV) MATERIALIZE */
           RSH.RECEIPT_NUM
          ,RT.TRANSACTION_DATE
          ,RT.QUANTITY AS RECEIPY_QTY
          ,RT.PO_HEADER_ID
          ,RT.PO_LINE_ID
          ,RSL.PO_DISTRIBUTION_ID
          ,RT.TRANSACTION_ID
          ,RT.PO_UNIT_PRICE
          ,ROUND((CASE 
              WHEN NVL(RSL.QUANTITY_DELIVERED, 0) <> 0 
              THEN (RT.QUANTITY * RT.PO_UNIT_PRICE)
              ELSE RSL.AMOUNT_RECEIVED 
            END), 2) AS RECEIPT_VALUE
    FROM   RCV_TRANSACTIONS RT
          ,RCV_SHIPMENT_HEADERS RSH
          ,RCV_SHIPMENT_LINES RSL
    WHERE  RT.SHIPMENT_HEADER_ID = RSH.SHIPMENT_HEADER_ID
      AND  RSL.SHIPMENT_LINE_ID = RT.SHIPMENT_LINE_ID
      AND  RSH.SHIPMENT_HEADER_ID = RT.SHIPMENT_HEADER_ID
      AND  RT.TRANSACTION_TYPE = 'RECEIVE' -- Receipt
)
```

---

## 4. PO Approval History
*Retrieves PO approval workflow with approvers.*

```sql
PO_APPROVER AS (
    SELECT /*+ qb_name(PO_APPR) MATERIALIZE */
           PAH.OBJECT_ID AS PO_HEADER_ID
          ,PAH.ACTION_DATE AS APPROVAL_DATE
          ,PPNF.DISPLAY_NAME AS APPROVER_NAME
          ,PPNF.FULL_NAME AS APPROVER_FULL_NAME
          ,PAH.ACTION_CODE
          ,PAH.SEQUENCE_NUM
          ,RANK() OVER (PARTITION BY PAH.OBJECT_ID ORDER BY PAH.ACTION_DATE) AS APPROVAL_RANK
    FROM   PO_ACTION_HISTORY PAH
          ,PER_PERSON_NAMES_F PPNF
    WHERE  PAH.PERFORMER_ID = PPNF.PERSON_ID
      AND  PAH.ACTION_CODE = 'APPROVE'
      AND  PAH.OBJECT_TYPE_CODE = 'PO'
      AND  PPNF.NAME_TYPE = 'GLOBAL'
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PPNF.EFFECTIVE_END_DATE)
)
```

---

## 5. Requisition Master
*Retrieves PR details with requester and approver.*

```sql
PR_MASTER AS (
    SELECT /*+ qb_name(PR_MST) MATERIALIZE */
           PRHA.REQUISITION_HEADER_ID
          ,PRHA.REQUISITION_NUMBER AS PR_NUMBER
          ,PRHA.DESCRIPTION AS PR_DESCRIPTION
          ,PRHA.CREATION_DATE AS PR_CREATION_DATE
          ,PRHA.APPROVED_DATE AS PR_APPROVED_DATE
          ,PRHA.DOCUMENT_STATUS AS PR_STATUS
          ,PRLA.REQUISITION_LINE_ID
          ,PRLA.LINE_NUMBER AS PR_LINE_NO
          ,PRLA.ITEM_DESCRIPTION AS PR_ITEM_DESC
          ,PRLA.QUANTITY AS PR_QUANTITY
          ,PRLA.CURRENCY_CODE AS PR_CURRENCY
          ,PRLA.RATE AS PR_EXCHANGE_RATE
          ,PRLA.PO_HEADER_ID
          ,PRLA.PO_LINE_ID
          ,PRDA.DISTRIBUTION_ID
          ,PRDA.REQ_DISTRIBUTION_ID
          ,ROUND(NVL(PRLA.ASSESSABLE_VALUE, 0), 2) AS PR_LINE_AMOUNT
    FROM   POR_REQUISITION_HEADERS_ALL PRHA
          ,POR_REQUISITION_LINES_ALL PRLA
          ,POR_REQ_DISTRIBUTIONS_ALL PRDA
    WHERE  PRHA.REQUISITION_HEADER_ID = PRLA.REQUISITION_HEADER_ID(+)
      AND  PRLA.REQUISITION_LINE_ID = PRDA.REQUISITION_LINE_ID(+)
)
```

---

## 6. PR Approval History
*Retrieves PR approval workflow.*

```sql
PR_APPROVER AS (
    SELECT /*+ qb_name(PR_APPR) MATERIALIZE */
           PAH.OBJECT_ID AS REQUISITION_HEADER_ID
          ,PAH.ACTION_DATE AS APPROVAL_DATE
          ,PPNF.DISPLAY_NAME AS APPROVER_NAME
          ,PPNF.FULL_NAME AS APPROVER_FULL_NAME
          ,RANK() OVER (PARTITION BY PAH.OBJECT_ID ORDER BY PAH.ACTION_DATE) AS APPROVAL_RANK
    FROM   PO_ACTION_HISTORY PAH
          ,PER_PERSON_NAMES_F PPNF
    WHERE  PAH.PERFORMER_ID = PPNF.PERSON_ID
      AND  PAH.ACTION_CODE = 'APPROVE'
      AND  PAH.OBJECT_TYPE_CODE = 'REQ'
      AND  PPNF.NAME_TYPE = 'GLOBAL'
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PPNF.EFFECTIVE_END_DATE)
)
```

---

## 7. Supplier Master
*Comprehensive supplier details with contact and bank info.*

```sql
SUPPLIER_MASTER AS (
    SELECT /*+ qb_name(SUPP_MST) MATERIALIZE */
           PSV.VENDOR_ID
          ,PSV.SEGMENT1 AS SUPPLIER_NUMBER
          ,PSV.VENDOR_NAME AS SUPPLIER_NAME
          ,PSV.VENDOR_TYPE_LOOKUP_CODE AS SUPPLIER_TYPE
          ,PSV.ATTRIBUTE_NUMBER1 AS ICV_PERCENTAGE
          ,PSV.ATTRIBUTE1 AS BUSINESS_SIZE
          ,PSSV.VENDOR_SITE_ID
          ,PSSV.VENDOR_SITE_CODE
          ,PSAV.ADDRESS1 AS ADDR_LINE1
          ,PSAV.ADDRESS2 AS ADDR_LINE2
          ,PSAV.CITY
          ,PSAV.POSTAL_CODE
          ,PSAV.COUNTRY
          ,PSAV.EMAIL_ADDRESS
          ,PSAV.PHONE_NUMBER
          ,ZPTP.REP_REGISTRATION_NUMBER AS TAX_REGISTRATION
    FROM   POZ_SUPPLIERS_V PSV
          ,POZ_SUPPLIER_SITES_V PSSV
          ,POZ_SUPPLIER_ADDRESS_V PSAV
          ,ZX_PARTY_TAX_PROFILE ZPTP
    WHERE  PSV.VENDOR_ID = PSSV.VENDOR_ID(+)
      AND  PSV.VENDOR_ID = PSAV.VENDOR_ID(+)
      AND  PSAV.PARTY_SITE_ID(+) = PSSV.PARTY_SITE_ID
      AND  PSV.PARTY_ID = ZPTP.PARTY_ID(+)
)
```

---

## 8. Buyer/Agent Master
*Retrieves buyer/agent details.*

```sql
BUYER_MASTER AS (
    SELECT /*+ qb_name(BUYER_MST) MATERIALIZE */
           PPNF.PERSON_ID
          ,PPNF.DISPLAY_NAME AS BUYER_NAME
          ,PPNF.FIRST_NAME || ' ' || PPNF.LAST_NAME AS BUYER_FULL_NAME
          ,PU.USERNAME AS BUYER_ID
    FROM   PER_PERSON_NAMES_F PPNF
          ,PER_USERS PU
    WHERE  PPNF.PERSON_ID = PU.PERSON_ID
      AND  PPNF.NAME_TYPE = 'GLOBAL'
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PPNF.EFFECTIVE_END_DATE)
)
```

---

## 9. Requester/Department Master
*Retrieves requester with department details.*

```sql
REQUESTER_MASTER AS (
    SELECT /*+ qb_name(REQ_MST) MATERIALIZE */
           PPNF.PERSON_ID
          ,PPNF.FIRST_NAME || ' ' || PPNF.LAST_NAME AS REQUESTER_NAME
          ,PU.USERNAME AS REQUESTER_ID
          ,PD.NAME AS REQUESTER_DEPARTMENT
          ,PAPF.PERSON_NUMBER AS EMPLOYEE_NUMBER
    FROM   PER_PERSON_NAMES_F PPNF
          ,PER_USERS PU
          ,PER_ALL_ASSIGNMENTS_F PAAF
          ,PER_DEPARTMENTS PD
          ,PER_ALL_PEOPLE_F PAPF
    WHERE  PPNF.PERSON_ID = PU.PERSON_ID
      AND  PPNF.PERSON_ID = PAAF.PERSON_ID
      AND  PAAF.ORGANIZATION_ID = PD.ORGANIZATION_ID
      AND  PAPF.PERSON_ID = PPNF.PERSON_ID
      AND  PPNF.NAME_TYPE = 'GLOBAL'
      AND  PAAF.PRIMARY_ASSIGNMENT_FLAG = 'Y'
      AND  PAAF.ASSIGNMENT_TYPE IN ('E', 'C')
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PPNF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PPNF.EFFECTIVE_END_DATE)
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PAAF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PAAF.EFFECTIVE_END_DATE)
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PD.EFFECTIVE_START_DATE) 
                              AND TRUNC(PD.EFFECTIVE_END_DATE)
      AND  TRUNC(SYSDATE) BETWEEN TRUNC(PAPF.EFFECTIVE_START_DATE) 
                              AND TRUNC(PAPF.EFFECTIVE_END_DATE)
)
```

---

## 10. Negotiation/Tender Master
*Retrieves negotiation/tender details with bids.*

```sql
NEGOTIATION_MASTER AS (
    SELECT /*+ qb_name(NEG_MST) MATERIALIZE */
           PAHA.AUCTION_HEADER_ID
          ,PAHA.DOCUMENT_NUMBER AS TENDER_NUMBER
          ,PAHA.AUCTION_TITLE AS TENDER_TITLE
          ,PAHA.AUCTION_STATUS
          ,PON_AUCTION_PKG.GET_AUCTION_STATUS_DISPLAY(PAHA.AUCTION_HEADER_ID, 'Y') AS TENDER_STATUS
          ,PAHA.CURRENCY_CODE
          ,PAHA.OPEN_BIDDING_DATE
          ,PAHA.CLOSE_BIDDING_DATE
          ,PAHA.AWARD_DATE
          ,PAHA.NUMBER_OF_BIDS
          ,PBR.REQUISITION_NUMBER
          ,PNST.STYLE_NAME AS TENDER_STYLE
    FROM   PON_AUCTION_HEADERS_ALL PAHA
          ,PON_BACKING_REQUISITIONS PBR
          ,PON_NEGOTIATION_STYLES_TL PNST
    WHERE  PAHA.AUCTION_HEADER_ID = PBR.AUCTION_HEADER_ID(+)
      AND  PAHA.STYLE_ID = PNST.STYLE_ID(+)
)
```

---

## 11. Bid Details Master
*Retrieves supplier bids with scoring.*

```sql
BID_DETAILS AS (
    SELECT /*+ qb_name(BID_DTL) MATERIALIZE */
           PBH.AUCTION_HEADER_ID
          ,PBH.BID_NUMBER
          ,PBH.TRADING_PARTNER_ID
          ,PBH.VENDOR_ID
          ,PSV.VENDOR_NAME AS BIDDER_NAME
          ,PBH.BID_STATUS
          ,PBH.AWARD_STATUS
          ,PBH.BUYER_BID_TOTAL AS BID_AMOUNT
          ,PBH.TOTAL_AWARD_AMOUNT AS AWARDED_AMOUNT
          ,PBH.SHORTLIST_FLAG
    FROM   PON_BID_HEADERS PBH
          ,POZ_SUPPLIERS_V PSV
    WHERE  PBH.TRADING_PARTNER_ID = PSV.PARTY_ID(+)
      AND  PBH.VENDOR_ID = PSV.VENDOR_ID(+)
)
```

---

## 12. Work Confirmation Master
*Retrieves work confirmation details.*

```sql
WORK_CONFIRMATION_MASTER AS (
    SELECT /*+ qb_name(WC_MST) MATERIALIZE */
           PWH.WORK_CONFIRMATION_ID
          ,PWH.WORK_CONFIRMATION_NUM
          ,PWH.PO_HEADER_ID
          ,PWH.STATUS AS WC_STATUS
          ,PWH.COMMENTS AS WC_DESCRIPTION
          ,PWH.CREATION_DATE AS WC_DATE
          ,TO_CHAR(PWH.CREATION_DATE, 'YYYY') AS WC_YEAR
          ,PWL.WORK_CONFIRMATION_LINE_ID
          ,PWL.LINE_LOCATION_ID
          ,PWL.AMOUNT AS WC_AMOUNT
    FROM   PO_WC_HEADERS PWH
          ,PO_WC_LINES PWL
    WHERE  PWH.WORK_CONFIRMATION_ID = PWL.WORK_CONFIRMATION_ID
      AND  PWH.PO_HEADER_ID IS NOT NULL
)
```

---

## 13. Item Master
*Retrieves item details with category.*

```sql
ITEM_MASTER AS (
    SELECT /*+ qb_name(ITEM_MST) MATERIALIZE */
           ESIV.INVENTORY_ITEM_ID
          ,ESIV.ORGANIZATION_ID
          ,ESIV.ITEM_NUMBER
          ,ESIV.DESCRIPTION AS ITEM_DESCRIPTION
          ,IUOMV.UNIT_OF_MEASURE AS PRIMARY_UOM
          ,ECV.CATEGORY_NAME AS ITEM_CATEGORY
    FROM   EGP_SYSTEM_ITEMS_VL ESIV
          ,INV_UNITS_OF_MEASURE_VL IUOMV
          ,EGP_ITEM_CATEGORIES EIC
          ,EGP_CATEGORIES_VL ECV
    WHERE  ESIV.PRIMARY_UOM_CODE = IUOMV.UOM_CODE(+)
      AND  ESIV.INVENTORY_ITEM_ID = EIC.INVENTORY_ITEM_ID(+)
      AND  ESIV.ORGANIZATION_ID = EIC.ORGANIZATION_ID(+)
      AND  EIC.CATEGORY_ID = ECV.CATEGORY_ID(+)
)
```
