# Inventory Repository Patterns

**Purpose:** Standardized CTEs for extracting Inv data.

---

## 1. Item Master
*Retrieves Item definition for a specific Org.*

```sql
INV_ITEM_MASTER AS (
    SELECT /*+ qb_name(ITEM) MATERIALIZE */
           MSI.INVENTORY_ITEM_ID
          ,MSI.ORGANIZATION_ID
          ,MSI.SEGMENT1 AS ITEM_NUMBER
          ,MSI.DESCRIPTION
          ,MSI.PRIMARY_UOM_CODE
    FROM   MTL_SYSTEM_ITEMS_B MSI
    WHERE  MSI.ORGANIZATION_ID IN (:P_ORG_ID)
)
```

---

## 2. On-Hand Quantity (Stock)
*Calculates current stock by Item/Subinventory with locator and project details.*

```sql
INV_ONHAND_MASTER AS (
    SELECT /*+ qb_name(ONHAND) MATERIALIZE */
           IOQD.ORGANIZATION_ID
          ,IOQD.INVENTORY_ITEM_ID
          ,IOQD.REVISION
          ,IOQD.SUBINVENTORY_CODE
          ,IOQD.LOCATOR_ID
          ,IOQD.TRANSACTION_UOM_CODE
          ,SUM(IOQD.TRANSACTION_QUANTITY) AS TRANSACTION_QUANTITY
          ,IOQD.PROJECT_ID
          ,IOQD.TASK_ID
          ,NVL2(IIL.STRUCTURE_INSTANCE_NUMBER, 
                FND_FLEX_EXT.GET_SEGS('INV', 'MTLL', IIL.STRUCTURE_INSTANCE_NUMBER, 
                                      IIL.INVENTORY_LOCATION_ID, IIL.SUBINVENTORY_ID), 
                NULL) AS LOCATOR_NAME
          ,ESIB.ITEM_NUMBER
          ,ESIB1.DESCRIPTION
          ,PPAB.SEGMENT1 AS PROJECT_NUMBER
          ,PTV.TASK_NUMBER
          ,CASE WHEN ESIB.LOT_CONTROL_CODE = 2 THEN 'Y' ELSE 'N' END AS LOT_CONTROL_CODE
          ,CASE WHEN ESIB.SERIAL_NUMBER_CONTROL_CODE != 1 THEN 'Y' ELSE 'N' END AS SERIAL_NUMBER_CONTROL_CODE
    FROM   INV_ONHAND_QUANTITIES_DETAIL IOQD
          ,INV_ITEM_LOCATIONS IIL
          ,EGP_SYSTEM_ITEMS_B ESIB
          ,EGP_SYSTEM_ITEMS_TL ESIB1
          ,PJF_PROJECTS_ALL_B PPAB
          ,PJF_TASKS_V PTV
    WHERE  IOQD.LOCATOR_ID = IIL.INVENTORY_LOCATION_ID(+)
      AND  IOQD.INVENTORY_ITEM_ID = ESIB.INVENTORY_ITEM_ID
      AND  IOQD.ORGANIZATION_ID = ESIB.ORGANIZATION_ID
      AND  ESIB.INVENTORY_ITEM_ID = ESIB1.INVENTORY_ITEM_ID
      AND  ESIB.ORGANIZATION_ID = ESIB1.ORGANIZATION_ID
      AND  IOQD.PROJECT_ID = PPAB.PROJECT_ID(+)
      AND  IOQD.PROJECT_ID = PTV.PROJECT_ID(+)
      AND  IOQD.TASK_ID = PTV.TASK_ID(+)
    GROUP BY 
           IOQD.ORGANIZATION_ID
          ,IOQD.INVENTORY_ITEM_ID
          ,IOQD.REVISION
          ,IOQD.SUBINVENTORY_CODE
          ,IOQD.LOCATOR_ID
          ,IOQD.TRANSACTION_UOM_CODE
          ,IOQD.PROJECT_ID
          ,IOQD.TASK_ID
          ,IIL.STRUCTURE_INSTANCE_NUMBER
          ,IIL.INVENTORY_LOCATION_ID
          ,IIL.SUBINVENTORY_ID
          ,ESIB.ITEM_NUMBER
          ,ESIB1.DESCRIPTION
          ,PPAB.SEGMENT1
          ,PTV.TASK_NUMBER
          ,ESIB.LOT_CONTROL_CODE
          ,ESIB.SERIAL_NUMBER_CONTROL_CODE
)
```

---

## 3. Inventory Transaction Master
*Retrieves all material transactions with source and destination details.*

```sql
INV_TRX_MASTER AS (
    SELECT /*+ qb_name(INV_TRX) MATERIALIZE */
           ITST.TRANSACTION_SOURCE_TYPE_NAME
          ,IMT.TRANSACTION_ID
          ,IMT.DISTRIBUTION_ACCOUNT_ID
          ,IRTH.DESCRIPTION
          ,ITR_S.MEANING AS HEADER_STATUS
          ,IMT.INVENTORY_ITEM_ID
          ,IMT.ORGANIZATION_ID AS ORGANIZATION_ID_INV
          ,IMT.SUBINVENTORY_CODE
          ,IMT.TRANSACTION_ACTION_ID
          ,IMT.TRANSACTION_DATE
          ,IMT.TRANSACTION_UOM
          ,IMT.TRANSACTION_QUANTITY
          ,IMT.TRANSACTION_SOURCE_NAME
          ,INV_ACTION.TRANSACTION_ACTION AS TRX_ACTION
          ,IMT.TRANSACTION_SOURCE_TYPE_ID
          ,IMT.CREATED_BY
          ,IMT.CREATION_DATE
          ,IMT.TRANSACTION_TYPE_ID
          ,IMT.TRANSFER_ORGANIZATION_ID
          ,IMT.REQUESTER_ID
          ,IMT.TRANSFER_SUBINVENTORY
          ,NVL(IMT.LOCATOR_ID, 0) AS LOCATOR_ID
          ,IMT.TRANSFER_TRANSACTION_ID
          ,IMT.CURRENCY_CODE
          ,CASE 
              WHEN IMT.JOB_DEFINITION_NAME IS NOT NULL 
              THEN 'Interfaced to costing'
              ELSE 'Pending interface to costing'
            END AS COSTING
          ,SUBINV.DESCRIPTION AS SUBDESC
          ,SUBINV.SUBINVENTORY_ID AS IMT_SUBINV_SUBINVENTORY_ID
          ,SUBINV.ORGANIZATION_ID AS IMT_SUBINV_ORGANIZATION_ID
          ,IMT.INVENTORY_ITEM_ID AS IMT_INVENTORY_ITEM_ID
          ,IMT.TRANSACTION_SET_ID
          ,IMT.TRANSACTION_SOURCE_ID
          ,IMT.SHIPMENT_NUMBER
          ,IMT.PICKING_LINE_ID
          ,IMT.RCV_TRANSACTION_ID
          ,IMT.PICK_SLIP_NUMBER
          ,IMT.TRANSACTION_REFERENCE
          ,ISO.SALES_ORDER_ID
          ,ISO.SALES_ORDER_NUMBER
          ,PHA.PO_HEADER_ID AS PO_HEADER_ID1
          ,PHA.SEGMENT1 AS PONUMBER
          ,PLA.LINE_NUM AS POLINE_NUM
          ,RSL.LINE_NUM AS SHLINE_NUM
          ,RSH.RECEIPT_NUM
          ,IMT.DEFAULT_TAXATION_COUNTRY AS TAXATION
          ,IMT.TRX_BUSINESS_CATEGORY
          ,IMT.PRODUCT_TYPE
          ,IMT.ASSESSABLE_VALUE
          ,IMT.TRANSFER_LOCATOR_ID
    FROM   INV_MATERIAL_TXNS IMT
          ,INV_ORG_PARAMETERS IOP
          ,INV_TXN_SOURCE_TYPES_VL ITST
          ,INV_TXN_REQUEST_HEADERS IRTH
          ,(SELECT LOOKUP_CODE, MEANING 
            FROM FND_LOOKUPS 
            WHERE LOOKUP_TYPE = 'INV_TXN_REQUEST_STATUS' 
              AND ENABLED_FLAG = 'Y') ITR_S
          ,(SELECT LOOKUP_CODE, MEANING AS TRANSACTION_ACTION 
            FROM FND_LOOKUP_VALUES 
            WHERE LOOKUP_TYPE = 'INV_TRANSACTION_ACTION' 
              AND SOURCE_LANG = 'US') INV_ACTION
          ,INV_SECONDARY_INVENTORIES SUBINV
          ,INV_SALES_ORDERS ISO
          ,RCV_TRANSACTIONS RTPEO
          ,PO_HEADERS_ALL PHA
          ,PO_LINES_ALL PLA
          ,RCV_SHIPMENT_HEADERS RSH
          ,RCV_SHIPMENT_LINES RSL
    WHERE  IMT.ORGANIZATION_ID = IOP.ORGANIZATION_ID
      AND  IMT.TRANSACTION_SOURCE_ID = IRTH.HEADER_ID(+)
      AND  IRTH.HEADER_STATUS = ITR_S.LOOKUP_CODE(+)
      AND  IMT.TRANSACTION_ACTION_ID = INV_ACTION.LOOKUP_CODE(+)
      AND  IMT.ORGANIZATION_ID = SUBINV.ORGANIZATION_ID(+)
      AND  IMT.SUBINVENTORY_CODE = SUBINV.SECONDARY_INVENTORY_NAME(+)
      AND  IMT.TRANSACTION_SOURCE_TYPE_ID = ITST.TRANSACTION_SOURCE_TYPE_ID(+)
      AND  IMT.TRANSACTION_SOURCE_ID = ISO.SALES_ORDER_ID(+)
      AND  IMT.RCV_TRANSACTION_ID = RTPEO.TRANSACTION_ID(+)
      AND  RTPEO.PO_HEADER_ID = PHA.PO_HEADER_ID(+)
      AND  RTPEO.PO_LINE_ID = PLA.PO_LINE_ID(+)
      AND  RTPEO.SHIPMENT_HEADER_ID = RSH.SHIPMENT_HEADER_ID(+)
      AND  RTPEO.SHIPMENT_LINE_ID = RSL.SHIPMENT_LINE_ID(+)
)
```

---

## 4. Transaction Type Master
*Retrieves transaction type descriptions.*

```sql
TRX_TYPE AS (
    SELECT /*+ qb_name(TRX_TYPE) MATERIALIZE */
           ITT_B.TRANSACTION_TYPE_ID
          ,ITT.TRANSACTION_TYPE_ID AS TRANSACTION_TYPE_ID1
          ,ITT.LANGUAGE
          ,ITT.TRANSACTION_TYPE_NAME
    FROM   INV_TRANSACTION_TYPES_B ITT_B
          ,INV_TRANSACTION_TYPES_TL ITT
    WHERE  ITT_B.TRANSACTION_TYPE_ID = ITT.TRANSACTION_TYPE_ID
      AND  USERENV('LANG') = ITT.LANGUAGE
)
```

---

## 5. Inventory Organization Master
*Retrieves organization details.*

```sql
INV_ORG AS (
    SELECT /*+ qb_name(INV_ORG) MATERIALIZE */
           IOP.ORGANIZATION_CODE
          ,IOP.ORGANIZATION_ID
          ,HOU.EFFECTIVE_END_DATE AS EFFECTIVE_END_DATE1
          ,HOU.EFFECTIVE_START_DATE AS EFFECTIVE_START_DATE1
          ,HOU.LANGUAGE AS LANGUAGE1
          ,HOU.NAME AS NAME4
          ,HOU.ORGANIZATION_ID AS ORGANIZATION_ID4
    FROM   INV_ORG_PARAMETERS IOP
          ,HR_ORGANIZATION_UNITS_F_TL HOU
    WHERE  IOP.ORGANIZATION_ID = HOU.ORGANIZATION_ID(+)
      AND  USERENV('LANG') = HOU.LANGUAGE(+)
)
```

---

## 6. Locator Master
*Retrieves locator/bin details with flex field segments.*

```sql
LOCATOR_V AS (
    SELECT /*+ qb_name(LOCATOR_V) MATERIALIZE */
           IIL.INVENTORY_LOCATION_ID
          ,IIL.STRUCTURE_INSTANCE_NUMBER
          ,IIL.SUBINVENTORY_ID
          ,ISI.ORGANIZATION_ID AS SUBINV_ORGANIZATION_ID
          ,ISI.SECONDARY_INVENTORY_NAME AS SECONDARY_INVENTORY_NAME1
          ,NVL2(IIL.STRUCTURE_INSTANCE_NUMBER, 
                FND_FLEX_EXT.GET_SEGS('INV', 'MTLL', IIL.STRUCTURE_INSTANCE_NUMBER, 
                                      IIL.INVENTORY_LOCATION_ID, IIL.SUBINVENTORY_ID), 
                NULL) AS LOCATOR_NAME
    FROM   INV_ITEM_LOCATIONS IIL
          ,INV_SECONDARY_INVENTORIES ISI
    WHERE  IIL.ORGANIZATION_ID(+) = ISI.ORGANIZATION_ID
      AND  IIL.SUBINVENTORY_CODE(+) = ISI.SECONDARY_INVENTORY_NAME
)
```

---

## 7. Item Details Master
*Comprehensive item details with category.*

```sql
ITEM_DETAILS AS (
    SELECT /*+ qb_name(ITEM_DTL) MATERIALIZE */
           ESI_B.INVENTORY_ITEM_ID
          ,ESI_B.ORGANIZATION_ID
          ,ESI_B.INVENTORY_ORGANIZATION_ID
          ,ESI_B.ITEM_NUMBER
          ,IUOMV.UNIT_OF_MEASURE AS PRIMARY_UOM_CODE
          ,ITETL.DESCRIPTION
          ,ITETL.INVENTORY_ITEM_ID AS INVENTORY_ITEM_ID1
          ,ITETL.LANGUAGE AS LANGUAGE2554
          ,ITETL.ORGANIZATION_ID AS ORGANIZATION_ID12573
          ,ECV.CATEGORY_NAME AS ITEM_CATEGORY
    FROM   EGP_SYSTEM_ITEMS_B_V ESI_B
          ,EGP_SYSTEM_ITEMS_TL_V ITETL
          ,INV_UNITS_OF_MEASURE_VL IUOMV
          ,EGP_ITEM_CATEGORIES EIC
          ,EGP_CATEGORIES_VL ECV
    WHERE  ESI_B.INVENTORY_ITEM_ID = ITETL.INVENTORY_ITEM_ID
      AND  ESI_B.ORGANIZATION_ID = ITETL.ORGANIZATION_ID
      AND  ESI_B.PRIMARY_UOM_CODE = IUOMV.UOM_CODE
      AND  USERENV('LANG') = ITETL.LANGUAGE
      AND  ESI_B.TEMPLATE_ITEM_FLAG = 'N'
      AND  ESI_B.INVENTORY_ITEM_ID = EIC.INVENTORY_ITEM_ID(+)
      AND  ESI_B.ORGANIZATION_ID = EIC.ORGANIZATION_ID(+)
      AND  EIC.CATEGORY_ID = ECV.CATEGORY_ID(+)
)
```

---

## 8. Cost Details
*Retrieves average cost from costing tables.*

```sql
COST AS (
    SELECT /*+ qb_name(COST) MATERIALIZE */
           ROUND(AVG(CPC.UNIT_COST_AVERAGE), 5) AS ACTUAL_COST
          ,CIT.EXTERNAL_SYSTEM_REF_ID
          ,CPC.COST_ORG_ID
          ,CPC.COST_BOOK_ID
          ,CPC.INVENTORY_ITEM_ID
          ,CTCS.INVENTORY_ORG_ID
    FROM   CST_INV_TRANSACTIONS CIT
          ,CST_TRANSACTIONS CTCS
          ,CST_PERPAVG_COST CPC
    WHERE  CIT.CST_INV_TRANSACTION_ID = CTCS.CST_INV_TRANSACTION_ID
      AND  CIT.EXTERNAL_SYSTEM_REFERENCE = 'FUSION'
      AND  CPC.COST_BOOK_ID = CTCS.COST_BOOK_ID
      AND  CPC.COST_ORG_ID = CTCS.COST_ORG_ID
      AND  CPC.VAL_UNIT_ID = CTCS.VAL_UNIT_ID
      AND  CPC.INVENTORY_ITEM_ID = CTCS.INVENTORY_ITEM_ID
      AND  CTCS.TRANSACTION_DATE != CPC.COST_END_DATE
      AND  CTCS.TRANSACTION_DATE BETWEEN CPC.COST_DATE AND CPC.COST_END_DATE
    GROUP BY 
           CIT.EXTERNAL_SYSTEM_REF_ID
          ,CPC.COST_ORG_ID
          ,CPC.COST_BOOK_ID
          ,CPC.INVENTORY_ITEM_ID
          ,CTCS.INVENTORY_ORG_ID
)
```

---

## 9. Receipt Master
*Retrieves receipt details for GRN tracking.*

```sql
RECEIPT AS (
    SELECT /*+ qb_name(RECEIPT) MATERIALIZE */
           RSL.PO_HEADER_ID
          ,RSL.PO_LINE_ID
          ,RSL.PO_DISTRIBUTION_ID
          ,RSL.WORK_CONFIRMATION_ID
          ,RSL.WORK_CONFIRMATION_LINE_ID
          ,RT.QUANTITY AS RECEIPY_QTY
          ,RSH.RECEIPT_NUM AS RECEIPT_NUMBER
          ,RT.TRANSACTION_ID
          ,TO_CHAR(RT.TRANSACTION_DATE, 'DD-Mon-YY', 'NLS_DATE_LANGUAGE = AMERICAN') AS RECEIPT_DATE
          ,SUM(ROUND(CASE 
              WHEN NVL(RSL.QUANTITY_DELIVERED, 0) <> 0 
              THEN (RT.QUANTITY * RT.PO_UNIT_PRICE)
              ELSE RSL.AMOUNT_RECEIVED 
            END, 2)) AS RECEIPT_VALUE
    FROM   RCV_SHIPMENT_HEADERS RSH
          ,RCV_SHIPMENT_LINES RSL
          ,RCV_TRANSACTIONS RT
    WHERE  RSH.SHIPMENT_HEADER_ID = RSL.SHIPMENT_HEADER_ID
      AND  RSL.SHIPMENT_LINE_ID = RT.SHIPMENT_LINE_ID
      AND  RSH.SHIPMENT_HEADER_ID = RT.SHIPMENT_HEADER_ID
      AND  RT.TRANSACTION_TYPE = 'RECEIVE'
    GROUP BY 
           RSL.PO_HEADER_ID
          ,RSL.PO_LINE_ID
          ,RSL.PO_DISTRIBUTION_ID
          ,RSL.WORK_CONFIRMATION_ID
          ,RSL.WORK_CONFIRMATION_LINE_ID
          ,RT.QUANTITY
          ,RSH.RECEIPT_NUM
          ,RT.TRANSACTION_ID
          ,TO_CHAR(RT.TRANSACTION_DATE, 'DD-Mon-YY', 'NLS_DATE_LANGUAGE = AMERICAN')
)
```
